<!DOCTYPE html>
<html>
<head>
    <title>QuickBooks OAuth Helper</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .step h3 { margin-top: 0; color: #333; }
        input[type="text"] { width: 100%; padding: 8px; font-family: monospace; }
        button { background: #0077C5; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a9e; }
        .token-display { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; word-break: break-all; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 3px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ðŸ”‘ QuickBooks OAuth Helper</h1>
    <p>This tool helps you get the access token, refresh token, and company ID for your QBO sandbox.</p>

    <div class="step">
        <h3>Step 1: Enter Your App Credentials</h3>
        <p>Enter your QuickBooks app's Client ID and Client Secret:</p>
        <label>Client ID:</label>
        <input type="text" id="clientId" placeholder="Your QBO Client ID">
        <br><br>
        <label>Client Secret:</label>
        <input type="text" id="clientSecret" placeholder="Your QBO Client Secret">
        <br><br>
        <label>Redirect URI (should match your QBO app settings):</label>
        <input type="text" id="redirectUri" value="http://localhost:3000/oauth-callback" placeholder="http://localhost:3000/oauth-callback">
        <br><br>
        <button onclick="generateAuthUrl()">Generate Authorization URL</button>
    </div>

    <div class="step" id="step2" style="display:none;">
        <h3>Step 2: Authorize Your App</h3>
        <p>Click this link to authorize your app with QuickBooks:</p>
        <div class="token-display">
            <a href="#" id="authLink" target="_blank">Click here to authorize</a>
        </div>
        <div class="warning">
            <strong>Important:</strong> After clicking the link, you'll be redirected to your redirect URI with a "code" parameter. Copy that code and paste it below.
        </div>
        <label>Authorization Code (from the redirect URL):</label>
        <input type="text" id="authCode" placeholder="Paste the authorization code here">
        <br><br>
        <button onclick="exchangeCode()">Exchange Code for Tokens</button>
    </div>

    <div class="step" id="step3" style="display:none;">
        <h3>Step 3: Your Tokens! ðŸŽ‰</h3>
        <p>Save these values as environment variables in Vercel:</p>

        <strong>Access Token:</strong>
        <div class="token-display" id="accessToken"></div>

        <strong>Refresh Token:</strong>
        <div class="token-display" id="refreshToken"></div>

        <strong>Company ID:</strong>
        <div class="token-display" id="companyId"></div>

        <div class="warning">
            <strong>Security Note:</strong> These are real credentials! Don't share them or commit them to git. Add them directly to your Vercel environment variables.
        </div>
    </div>

    <script>
        function generateAuthUrl() {
            const clientId = document.getElementById('clientId').value;
            const redirectUri = encodeURIComponent(document.getElementById('redirectUri').value);

            if (!clientId || !redirectUri) {
                alert('Please enter Client ID and Redirect URI');
                return;
            }

            const scope = 'com.intuit.quickbooks.accounting';
            const state = 'state-' + Math.random().toString(36).substr(2, 9);

            const authUrl = `https://appcenter.intuit.com/connect/oauth2?` +
                `client_id=${clientId}&` +
                `scope=${scope}&` +
                `redirect_uri=${redirectUri}&` +
                `response_type=code&` +
                `access_type=offline&` +
                `state=${state}`;

            document.getElementById('authLink').href = authUrl;
            document.getElementById('step2').style.display = 'block';

            // Store for later use
            window.qboClientId = clientId;
            window.qboClientSecret = document.getElementById('clientSecret').value;
            window.qboRedirectUri = document.getElementById('redirectUri').value;
        }

        async function exchangeCode() {
            const authCode = document.getElementById('authCode').value;

            if (!authCode) {
                alert('Please enter the authorization code');
                return;
            }

            const tokenUrl = 'https://oauth.platform.intuit.com/oauth2/v1/tokens/bearer';

            const params = new URLSearchParams({
                grant_type: 'authorization_code',
                code: authCode,
                redirect_uri: window.qboRedirectUri
            });

            const credentials = btoa(`${window.qboClientId}:${window.qboClientSecret}`);

            try {
                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${credentials}`,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: params
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const tokenData = await response.json();

                // Extract company ID from the realmId that should be in the auth code URL
                // For now, we'll need to get it from the URL manually
                const urlParams = new URLSearchParams(window.location.search);
                const realmId = urlParams.get('realmId') || 'REALM_ID_NOT_FOUND';

                document.getElementById('accessToken').textContent = tokenData.access_token;
                document.getElementById('refreshToken').textContent = tokenData.refresh_token;
                document.getElementById('companyId').textContent = realmId;

                document.getElementById('step3').style.display = 'block';

            } catch (error) {
                alert('Error exchanging code for tokens: ' + error.message);
                console.error('Token exchange error:', error);
            }
        }

        // Check if we have auth code in URL (from redirect)
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const realmId = urlParams.get('realmId');

            if (code) {
                document.getElementById('authCode').value = code;
                document.getElementById('step2').style.display = 'block';

                // Store realmId for later
                if (realmId) {
                    window.qboRealmId = realmId;
                }
            }
        };
    </script>
</body>
</html>