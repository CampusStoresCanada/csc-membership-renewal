<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSC Membership Renewal - Campus Stores Canada</title>
    
    <!-- External Fonts -->
    <link rel="stylesheet" href="https://use.typekit.net/ilr6ctr.css">
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    
    <!-- YOUR CUSTOM STYLESHEET -->
    <link rel="stylesheet" href="vendor-wizard.css">
</head>
<body>
    <div class="wizard-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="loading-title">
                Loading<span class="dots">
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                </span>
            </div>
        </div>

        <!-- Upload Animation State -->
        <div class="uploading-state" id="uploadingState">
            <div class="uploading-title">
                Uploading<span class="dots">
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                </span>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error">
            <strong>Oops!</strong> <span id="errorMessage"></span>
        </div>

        <!-- Success State -->
        <div id="successState" class="success">
            <h3>✅ Profile Updated Successfully!</h3>
            <p>Thank you for completing your booth profile. Your information is now under review and will appear on the conference map once approved.</p>
        </div>

        <!-- All Content - Hidden until loaded -->
        <div class="wizard-content" id="wizardContent">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="logo-section">
                    <div class="logo-container">
                        <img src="https://images.squarespace-cdn.com/content/v1/5ec55d5d28a93e0e18d2eeb4/1600096854522-HS7NUI12I1ML6SPJFLLY/Artboard+1.png?format=1500w" alt="Campus Stores Canada" class="csc-logo">
                        <div id="organizationLogo" class="organization-logo-container"></div>
                    </div>
                </div>

                <div class="step-navigation">
                    <div class="step-item" data-step="0">
                        <div class="step-number">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28.01 28.01">
                                <path d="M14.01,28.01C6.28,28.01,0,21.73,0,14.01S6.28,0,14.01,0s14.01,6.28,14.01,14.01-6.28,14.01-14.01,14.01ZM14.01,2C7.39,2,2,7.39,2,14.01s5.39,12.01,12.01,12.01,12.01-5.39,12.01-12.01S20.63,2,14.01,2Z"/>
                                <path d="M13.25,22.55v-13.78l-1.63.89-1.06-1.8,4.51-2.4h.38v17.09h-2.21Z"/>
                            </svg>
                        </div>
                        <div class="step-title">Institution Information</div>
                    </div>
                    <div class="step-item" data-step="1">
                        <div class="step-number">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28.04 28.01">
                                <path d="M13.98,28.01C6.25,28.01-.03,21.73-.03,14.01S6.25,0,13.98,0s14.01,6.28,14.01,14.01-6.28,14.01-14.01,14.01ZM13.98,2C7.36,2,1.97,7.39,1.97,14.01s5.39,12.01,12.01,12.01,12.01-5.39,12.01-12.01S20.6,2,13.98,2Z"/>
                                <path d="M8.94,22.55v-.82l5.21-7.15c1.44-1.97,2.18-3.34,2.18-4.73,0-1.66-1.06-2.47-2.42-2.47-1.46,0-2.47.94-2.47,2.35,0,1.27.84,1.78.84,1.78l-1.7,1.25s-1.44-1.15-1.44-3c0-1.49.96-4.3,4.99-4.3s4.58,2.98,4.58,4.51c0,.79-.12,2.16-2.06,4.8l-4.32,5.9h6.7v1.87h-10.08Z"/>
                            </svg>
                        </div>
                        <div class="step-title">Contact Management</div>
                    </div>
                    <div class="step-item" data-step="2">
                        <div class="step-number">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28.01 28.25">
                                <path d="M14.01,28.25C6.28,28.25,0,21.97,0,14.25S6.28.24,14.01.24s14.01,6.28,14.01,14.01-6.28,14.01-14.01,14.01ZM14.01,2.24C7.39,2.24,2,7.63,2,14.25s5.39,12.01,12.01,12.01,12.01-5.39,12.01-12.01S20.63,2.24,14.01,2.24Z"/>
                                <path d="M10.36,18.67c.46,1.03,1.46,2.33,3.41,2.33,2.09,0,3.1-1.51,3.1-3.43,0-1.8-.86-3.22-3.41-3.22h-1.32v-1.87h1.37c2.02,0,2.78-.89,2.78-2.47s-.79-2.52-2.35-2.52c-1.39,0-2.23.72-2.86,2.11l-1.73-1.10c.79-1.58,2.14-2.93,4.66-2.93,2.93,0,4.66,1.82,4.66,4.25s-1.63,3.24-2.4,3.48c.65.19,2.98.94,2.98,4.22s-2.45,5.42-5.47,5.42c-2.69,0-4.32-1.63-4.99-3.12l1.58-1.15Z"/>
                            </svg>
                        </div>
                        <div class="step-title">Billing</div>
                    </div>
                    <div class="step-item" data-step="3">
                        <div class="step-number">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28.01 28.01">
                                <path d="M14.01,28.01C6.28,28.01,0,21.73,0,14.01S6.28,0,14.01,0s14.01,6.28,14.01,14.01-6.28,14.01-14.01,14.01ZM14.01,2C7.39,2,2,7.39,2,14.01s5.39,12.01,12.01,12.01,12.01-5.39,12.01-12.01S20.63,2,14.01,2Z"/>
                                <path d="M15.23,22.31v-5.38h-6.84v-1.15l4.22-10.27h2.35l-3.84,9.55h4.1v-5.62h2.26v5.62h2.23v1.87h-2.23v5.38h-2.26Z"/>
                            </svg>
                        </div>
                        <div class="step-title">Invoice and Payment</div>
                    </div>
                </div>
            </div>
            <!-- Main Content -->
            <div class="main-content">
                <!-- Mobile Progress Bar -->
                <div class="mobile-progress">
                    <div class="mobile-progress-fill" style="width: 0%"></div>
                </div>

                <!-- Welcome Screen -->
                <div id="welcomeSection" class="content-section active">
                    <div class="welcome-container">
                        <div class="welcome-section">
                            <h1 class="welcome-title">Welcome to CSC Membership Renewal!</h1>
                            <p class="welcome-text">
                                Thank you for renewing your Campus Stores Canada membership for the 2025-26 year.
                            </p>
                            <p class="welcome-text">
                                We'll guide you through updating your institution information, managing your team contacts, setting up billing preferences, and completing your payment.
                            </p>
                            <p class="welcome-text">
                                This process should take just a few minutes, and you can save your progress at any time. Let's get started!
                            </p>
                            <button class="get-started-btn" onclick="startWizard()">
                                Get started <span>→</span>
                            </button>
                        </div>
                        
                    </div>
                </div>

                <!-- Step 1: Company Information -->
                <div id="step1Section" class="content-section">
                    <div class="step-header">
                        <h2 class="step-title-main">Institution Information</h2>
                        <p class="step-subtitle">Please verify and update your institution's membership details:</p>
                    </div>

                    <div class="form-container">
                        <!-- Institution Name Field -->
                        <div class="form-field" data-field="institutionName">
                            <div class="field-display" id="institutionNameDisplay">Loading...</div>
                            <button class="edit-btn" onclick="editField('institutionName')" id="editInstitutionName">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                                    <path d="m14.5 5.5 4 4"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Institution Website Field -->
                        <div class="form-field" data-field="website">
                            <div class="field-display" id="websiteDisplay">Institution website (university.ca)</div>
                            <button class="edit-btn" onclick="editField('website')" id="editWebsite">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                                    <path d="m14.5 5.5 4 4"/>
                                </svg>
                            </button>
                        </div>


                        <!-- Institution Size Field -->
                        <div class="form-field" data-field="institutionSize">
                            <div class="custom-dropdown" id="institutionSizeDropdown">
                                <div class="dropdown-display" id="institutionSizeDisplay">
                                    <span id="institutionSizeText">Select institution size</span>
                                    <svg class="dropdown-arrow" viewBox="0 0 19.87 12.22">
                                        <path d="M19.68.11c-.21-.17-.52-.15-.7.07l-9.03,10.77-.02-.02-.02.02L.88.18C.7-.04.39-.06.18.11-.04.29-.06.61.11.82l9.42,11.22c.1.12.24.18.38.18h.04c.14,0,.28-.06.38-.18L19.75.82c.17-.21.15-.53-.07-.71Z" fill="#999999"/>
                                    </svg>
                                </div>
                                <div class="dropdown-options" id="institutionSizeOptions" style="display: none;">
                                    <!-- Options will be populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Address Block -->
                        <div class="form-field" data-field="address">
                            <div class="field-display address-block" id="addressDisplay">
                                <div class="address-line-1" id="addressLine1">Street address</div>
                                <div class="address-line-2" id="addressLine2">
                                    <span id="cityPart">City</span>, <span id="provincePart">Province</span> <span id="postalCodePart">Postal Code</span>
                                </div>
                            </div>
                            <button class="edit-btn" onclick="editField('address')" id="editAddress">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                                    <path d="m14.5 5.5 4 4"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <button class="previous-btn" onclick="previousStep()">
                        <span>←</span>
                        Previous step
                    </button>
                    <button class="next-btn" onclick="nextStep()">
                        Next step
                        <span>→</span>
                    </button>
                </div>

                <!-- Step 2: Conference Highlight -->
                <div id="step2Section" class="content-section">
                    <div class="step-header">
                        <h2 class="step-title-main">Campus store team</h2>
                        <p class="step-subtitle">Please update your institutional contacts. You can also indicate who is attending the conference, and who your institution's primary contact should be.</p>
                    </div>

                    <div class="team-container">
                        <div class="team-list-wrapper">
                            <div class="team-list" id="teamList">
                                <!-- Contacts will be dynamically added here -->
                            </div>
                            <div class="team-list-fade"></div>
                            <div class="team-list-shadow"></div>
                            <div class="custom-scrollbar" id="teamScrollbar">
                                <div class="scrollbar-track">
                                    <div class="scrollbar-thumb" id="scrollbarThumb"></div>
                                </div>
                            </div>
                        </div>

                        <div class="add-contact-section">
                            <div class="add-contact-item" id="addContactItem">
                                <div class="contact-checkbox">
                                    <div class="checkbox-circle"></div>
                                </div>
                                <div class="contact-info">
                                    <div class="contact-name">A new contact</div>
                                    <div class="contact-details">You can add all the contacts our members should know, attending or not.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <button class="previous-btn" onclick="previousStep()">
                        <span>←</span>
                        Previous step
                    </button>
                    <button class="next-btn" onclick="nextStep()">
                        Next step
                        <span>→</span>
                    </button>
                </div>
                <!-- Step 3: Billing -->
                <div id="step3Section" class="content-section">
                    <div class="step-header">
                        <h2 class="step-title-main">Billing</h2>
                        <p class="step-subtitle">Let's make sure that you are getting billed in a way that makes sense for your institution.</p>
                    </div>

                    <div class="form-container">
                        <!-- How billing should appear -->
                        <div class="form-field" data-field="billingDisplay">
                            <div class="custom-dropdown" id="billingDisplayDropdown">
                                <div class="dropdown-display" id="billingDisplayDisplay">
                                    <span id="billingDisplayText">How would you like billing to appear?</span>
                                    <svg class="dropdown-arrow" viewBox="0 0 19.87 12.22">
                                        <path d="M19.68.11c-.21-.17-.52-.15-.7.07l-9.03,10.77-.02-.02-.02.02L.88.18C.7-.04.39-.06.18.11-.04.29-.06.61.11.82l9.42,11.22c.1.12.24.18.38.18h.04c.14,0,.28-.06.38-.18L19.75.82c.17-.21.15-.53-.07-.71Z" fill="#999999"/>
                                    </svg>
                                </div>
                                <div class="dropdown-options" id="billingDisplayOptions" style="display: none;">
                                    <div class="dropdown-option" data-value="single-item">Bill as a single item</div>
                                    <div class="dropdown-option" data-value="membership-conference">Bill as Membership and Conference Registration</div>
                                    <div class="dropdown-option" data-value="individual-line-items">Bill Individual Line Items</div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment method -->
                        <div class="form-field" data-field="paymentMethod">
                            <div class="custom-dropdown" id="paymentMethodDropdown">
                                <div class="dropdown-display" id="paymentMethodDisplay">
                                    <span id="paymentMethodText">Pay now with receipt or pay by cheque?</span>
                                    <svg class="dropdown-arrow" viewBox="0 0 19.87 12.22">
                                        <path d="M19.68.11c-.21-.17-.52-.15-.7.07l-9.03,10.77-.02-.02-.02.02L.88.18C.7-.04.39-.06.18.11-.04.29-.06.61.11.82l9.42,11.22c.1.12.24.18.38.18h.04c.14,0,.28-.06.38-.18L19.75.82c.17-.21.15-.53-.07-.71Z" fill="#999999"/>
                                    </svg>
                                </div>
                                <div class="dropdown-options" id="paymentMethodOptions" style="display: none;">
                                    <div class="dropdown-option" data-value="pay-now">Pay Now (Credit/Debit/EFT)</div>
                                    <div class="dropdown-option" data-value="invoice">Send Invoice (Pay by Cheque)</div>
                                </div>
                            </div>
                        </div>

                        <!-- Invoice Preview -->
                        <div class="form-field" data-field="invoicePreview">
                            <div class="field-display preview-note">This is a preview, we will be generate your final invoice based on what YOU select on this page.</div>
                        </div>
                    </div>


                    <!-- Navigation Buttons -->
                    <button class="previous-btn" onclick="previousStep()">
                        <span>←</span>
                        Previous step
                    </button>
                    <button class="next-btn" onclick="nextStep()">
                        Next step
                        <span>→</span>
                    </button>
                </div>
                <!-- Step 4: Primary Contact -->
                <div id="step4Section" class="content-section">
                    <div class="step-header">
                        <h2 class="step-title-main">Invoice and Payment</h2>
                        <p class="step-subtitle">Review your membership details and complete your payment to finalize your CSC membership renewal.</p>
                    </div>
                
                    <div class="form-container">
                        <!-- Payment Summary -->
                        <div class="form-field" data-field="paymentSummary">
                            <div class="field-display">
                                <h3>Membership Summary</h3>
                                <div class="payment-details">
                                    <div class="payment-line">CSC Membership 2025-26: <span class="payment-amount">$XXX.XX</span></div>
                                    <div class="payment-line total">Total: <span class="payment-amount">$XXX.XX</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Button -->
                        <div class="form-field" data-field="paymentAction">
                            <button class="next-btn payment-btn" onclick="processPayment()">
                                Payment Page
                                <span>→</span>
                            </button>
                        </div>
                    </div>
                
                    <!-- Navigation Buttons -->
                    <button class="previous-btn" onclick="previousStep()">
                        <span>←</span>
                        Previous step
                    </button>
                    <button class="next-btn" onclick="nextStep()">
                        Next step
                        <span>→</span>
                    </button>
                </div>
                <!-- Step 5: Product Catalogue -->
                <div id="step5Section" class="content-section">
                    <div class="step-header">
                        <h2 class="step-title-main">Product catalogue</h2>
                        <p class="step-subtitle">Please upload a product catalogue, or other representation of your organization. This is a great spot to show of the depth of your company.</p>
                    </div>
                
                    <div class="catalogue-container">
                        <div class="catalogue-instruction">
                            <em>Upload ONE 25MB file. PDF's preferred.</em>
                        </div>
                        
                        <div class="catalogue-upload-container" id="catalogueUploadContainer">
                            <div class="catalogue-placeholder" id="cataloguePlaceholder">
                                <svg viewBox="0 0 168.51 197.32" class="pdf-icon">
                                    <path d="M66.2,114.19h-3.44v27.54h3.44c11.69,0,14.81-6.36,14.81-13.64s-3.12-13.9-14.81-13.9ZM66.2,114.19h-3.44v27.54h3.44c11.69,0,14.81-6.36,14.81-13.64s-3.12-13.9-14.81-13.9ZM165.47,38.54L130.07,3.06c-1.95-1.96-4.61-3.06-7.37-3.06H30.27c-5.75,0-10.42,4.67-10.42,10.42v79.78h-9.54c-5.69,0-10.31,4.62-10.31,10.31v54.89c0,5.69,4.62,10.31,10.31,10.31h9.54v21.18c0,5.75,4.67,10.42,10.42,10.42h127.81c5.75,0,10.42-4.67,10.42-10.42V45.9c0-2.76-1.1-5.4-3.04-7.36ZM24.25,133.81v16.89h-9.74v-45.46h13.77c12.34,0,17.54,5.33,17.54,14.35s-4.94,14.22-17.54,14.22h-4.03ZM159.6,185.64c0,1.36-1.1,2.47-2.47,2.47H31.17c-1.36,0-2.47-1.1-2.47-2.47v-19.92h97.35c5.7,0,10.31-4.62,10.31-10.31v-54.89c0-5.69-4.61-10.31-10.31-10.31H28.7V11.52c0-1.36,1.1-2.46,2.47-2.46h90.04v28c0,5.65,4.58,10.24,10.24,10.24h28.15v138.35ZM52.76,150.69v-45.46h15.72c15.33,0,22.99,9.87,22.99,22.86s-7.66,22.6-22.99,22.6h-15.72ZM124.91,123.15v8.96h-15.72v18.58h-10v-45.46h27.02v8.96h-17.02v8.96h15.72ZM66.2,114.19h-3.44v27.54h3.44c11.69,0,14.81-6.36,14.81-13.64s-3.12-13.9-14.81-13.9ZM28.93,113.67h-4.68v11.43h4.68c4.94,0,6.62-2.2,6.62-5.71s-1.69-5.71-6.62-5.71Z" fill="#fff"/>
                                </svg>
                            </div>
                            <div class="catalogue-overlay" id="catalogueOverlay">Click to select file</div>
                            <div class="upload-progress" id="catalogueUploadProgress">
                                <div class="upload-progress-fill" id="catalogueUploadProgressFill"></div>
                            </div>
                            <div class="catalogue-success" id="catalogueSuccess" style="display: none;">
                                <div class="success-icon">✓</div>
                                <div class="success-text">Catalogue uploaded successfully!</div>
                                <div class="success-filename" id="successFilename"></div>
                            </div>
                            <div class="catalogue-error-message" id="catalogueError"></div>
                        </div>
                        
                        <input type="file" class="hidden-file-input" id="catalogueFileInput" accept=".pdf">
                    </div>
                
                    <!-- Navigation Buttons -->
                    <button class="previous-btn" onclick="previousStep()">
                        <span>←</span>
                        Previous step
                    </button>
                    <button class="next-btn" onclick="finishWizard()">
                        Finish
                        <span>→</span>
                    </button>
                </div> 
                 <!-- Step 6: Upload Results -->
                <div id="step6Section" class="content-section">
                    <div class="welcome-section">
                        <!-- Success content (hidden initially) -->
                        <div id="successContent" style="display: none;">
                            <h1 class="welcome-title">
                                <span>🎉</span>
                                Success!
                            </h1>
                            <p class="welcome-text">
                                Things are in process. There is a human review process underway.
                                In general we'll try to get this done in a couple of minutes.
                            </p>
                            <p class="welcome-text">
                                If you haven't seen an update go live and it has been a couple hours,
                                and is between 8:30 AM and 4:30 PM Mountain Time on a
                                weekday, you can reach out to <a href="mailto:google@campusstores.ca" style="color: #0071bc;">Steve Thomas</a>.
                            </p>
                            <p class="welcome-text">
                                Thanks once again for choosing to support Campus Stores Canada,
                                our members, and the more than 2 million students, faculty and
                                staff represented by CSC.
                            </p>
                        </div>
                        
                        <!-- Error content (hidden initially) -->
                        <div id="errorContent" style="display: none;">
                            <h1 class="welcome-title" style="color: #dc3545;">
                                <span>😱</span>
                                Uh-oh
                            </h1>
                            <p class="welcome-text">
                                Oh, uhmm... this is awkward. Something is wrong. We are probably
                                getting a really weird series of alerts right now and also freaking out.
                            </p>
                            <p class="welcome-text">
                                If it is between 8:30 AM and 4:30 PM Mountain Time on a
                                weekday, can you reach out to <a href="mailto:google@campusstores.ca" style="color: #0071bc;">Steve Thomas</a>?
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Crop Modal -->
                <div class="crop-modal" id="cropModal">
                    <div class="crop-container">
                        <div class="crop-header">
                            <div class="crop-title">Crop your image</div>
                            <div class="crop-subtitle">Adjust the image to fit a 9:16 aspect ratio (portrait)</div>
                        </div>
                        <div class="crop-image-container">
                            <img class="crop-image" id="cropImage" alt="Image to crop">
                        </div>
                        <div class="crop-actions">
                            <button class="crop-btn secondary" onclick="cancelCrop()">Cancel</button>
                            <button class="crop-btn primary" onclick="applyCrop()">Apply Crop</button>
                        </div>
                    </div>
                </div>
            </div>
    <script>
        // ===========================================
        // WIZARD STATE MANAGEMENT
        // ===========================================
        let currentStep = 0;
        const totalSteps = 6;
        let vendorData = {};
        let organizationContacts = [];
        let conferenceTeam = [];
        let categoryDropdownOpen = false;
        let activeField = null;
        let formState = {
            // Step 1
            companyName: '',
            website: '',
            category: '',
            description: '',
            // Step 2
            highlightHeadline: '',
            highlightDescription: '',
            highlightDeal: '',
            highlightImageUrl: ''
        };
        
        const API_BASE = '/api';
        
        // ===========================================
        // CROPPER MANAGEMENT
        // ===========================================
        let cropperInstance = null;
        let currentFile = null;
        let initializedSteps = new Set();

        // ===========================================
        // HANDLE ORIENTATION CHANGES
        // ===========================================
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                initialViewportHeight = window.innerHeight;
            }, 500);
        });
        
        // ===========================================
        // MOBILE INITIALIZATION
        // ===========================================
        
        
        document.addEventListener('DOMContentLoaded', () => {
            // Get started button handler
            const mobileGetStartedBtn = document.getElementById('mobileGetStartedBtn');
            if (mobileGetStartedBtn) {
                mobileGetStartedBtn.addEventListener('click', startWizard);
            }
            
            // Previous button handler
            const mobilePrevBtn = document.getElementById('mobilePrevBtn');
            if (mobilePrevBtn) {
                mobilePrevBtn.addEventListener('click', previousStep);
            }
            
            // Next button handler (handles both next and finish)
            const mobileNextBtn = document.getElementById('mobileNextBtn');
            if (mobileNextBtn) {
                mobileNextBtn.addEventListener('click', () => {
                    if (currentStep === 5) {
                        finishWizard();
                    } else {
                        nextStep();
                    }
                });
            }
        });
        
        // ===========================================
        // MOBILE ENHANCEMENTS
        // ===========================================
        
        // Prevent zoom on input focus for iOS
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
        }

        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                initialViewportHeight = window.innerHeight;
                isMobile = window.innerWidth <= 768;

                
                // Call your existing updateMobileProgress function if it exists
                if (typeof updateMobileProgress === 'function') {
                    updateMobileProgress();
                }
                
                // Force layout recalculation
                document.body.style.height = '100vh';
                setTimeout(() => {
                    document.body.style.height = 'auto';
                }, 100);
            }, 500);
        });

        // Improve touch scrolling on mobile
        if ('ontouchstart' in window) {
            document.addEventListener('touchstart', () => {}, { passive: true });
            document.addEventListener('touchmove', () => {}, { passive: true });
        }

        // Add scroll-to-top for mobile navigation
        function addMobileScrollToTop() {
            if (window.innerWidth <= 768) {
                window.scrollTo(0, 0);
            }
        }
        
        console.log('📱 Mobile-optimized vendor profile wizard loaded!');

        // ===========================================
        // GLOBAL ESC KEY HANDLER
        // ===========================================

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close modals first (highest priority)
                const contactModal = document.getElementById('contactModal');
                const invoiceModal = document.getElementById('invoiceModal');
                const cropModal = document.getElementById('cropModal');

                if (contactModal && contactModal.classList.contains('active')) {
                    cancelContactModal();
                    return;
                }

                if (invoiceModal) {
                    closeInvoiceModal();
                    return;
                }

                if (cropModal && cropModal.style.display === 'flex') {
                    cancelCrop();
                    return;
                }

                // Close any open dropdowns
                const openDropdowns = document.querySelectorAll('.dropdown-options[style*="block"]');
                openDropdowns.forEach(dropdown => {
                    dropdown.style.display = 'none';
                    const dropdownDisplay = dropdown.parentElement.querySelector('.dropdown-display');
                    if (dropdownDisplay) {
                        dropdownDisplay.classList.remove('open');
                    }
                });

                // If any dropdowns were closed, blur focus
                if (openDropdowns.length > 0) {
                    document.activeElement.blur();
                }

                console.log('🔐 ESC pressed - closed modals/dropdowns');
            }
        });

        // ===========================================
        // CUSTOM DROPDOWN FUNCTIONALITY - Updated for membership renewal
        // ===========================================
        function initializeDropdown() {
            console.log('🔧 Initializing dropdowns...');

            // Try category dropdown first (legacy)
            const categoryDropdown = document.getElementById('categoryDropdown');
            const categoryDisplay = document.getElementById('categoryDisplay');
            const categoryOptions = document.getElementById('categoryOptions');
            const categoryText = document.getElementById('categoryText');

            // Try institution size dropdown
            const sizeDropdown = document.getElementById('institutionSizeDropdown');
            const sizeDisplay = document.getElementById('institutionSizeDisplay');
            const sizeOptions = document.getElementById('institutionSizeOptions');
            const sizeText = document.getElementById('institutionSizeText');

            // Try province dropdown
            const provinceDropdown = document.getElementById('provinceDropdown');
            const provinceDisplay = document.getElementById('provinceDisplay');
            const provinceOptionsElement = document.getElementById('provinceOptions');
            const provinceTextElement = document.getElementById('provinceText');

            // Initialize category dropdown if it exists
            if (categoryDropdown && categoryDisplay && categoryOptions && categoryText) {
                console.log('✅ Initializing category dropdown');
                initializeSpecificDropdown(categoryDropdown, categoryDisplay, categoryOptions, categoryText, 'category');
            }

            // Initialize institution size dropdown if it exists
            if (sizeDropdown && sizeDisplay && sizeOptions && sizeText) {
                console.log('✅ Initializing institution size dropdown');
                initializeSpecificDropdown(sizeDropdown, sizeDisplay, sizeOptions, sizeText, 'institutionSize');
            }

            // Initialize province dropdown if it exists
            if (provinceDropdown && provinceDisplay && provinceOptionsElement && provinceTextElement) {
                console.log('✅ Initializing province dropdown');
                initializeSpecificDropdown(provinceDropdown, provinceDisplay, provinceOptionsElement, provinceTextElement, 'province');
            }
        }

        function initializeSpecificDropdown(dropdown, display, options, text, fieldType) {

            // Click on display to toggle dropdown
            display.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = options.style.display === 'block';
                
                if (isOpen) {
                    closeDropdown();
                } else {
                    openDropdown();
                }
            });
            
            // Click on options
            options.addEventListener('click', (e) => {
                if (e.target.classList.contains('dropdown-option')) {
                    const value = e.target.getAttribute('data-value');
                    selectOption(value);
                    closeDropdown();
                }
            });
            
            // Click outside to close
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    closeDropdown();
                }
            });
            
            function openDropdown() {
                options.style.display = 'block';
                display.classList.add('open');
                const currentValue = formState[fieldType];
                options.querySelectorAll('.dropdown-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.getAttribute('data-value') === currentValue) {
                        option.classList.add('selected');
                    }
                });
            }
            
            function closeDropdown() {
                options.style.display = 'none';
                display.classList.remove('open');
                // Dropdown closed
            }
            
            function selectOption(value) {
                formState[fieldType] = value;

                // For institution size, we need to show the label, not the value
                if (fieldType === 'institutionSize' || fieldType === 'billingDisplay' || fieldType === 'paymentMethod') {
                    const selectedOption = options.querySelector(`[data-value="${value}"]`);
                    if (selectedOption) {
                        text.textContent = selectedOption.textContent;
                    }
                } else {
                    text.textContent = value;
                }

                display.classList.remove('placeholder');
                console.log(`📝 Selected ${fieldType}:`, value);
            }
        }

        function initializeBillingDropdowns() {
            // Initialize billing display dropdown
            const billingDropdown = document.getElementById('billingDisplayDropdown');
            const billingDisplay = document.getElementById('billingDisplayDisplay');
            const billingOptions = document.getElementById('billingDisplayOptions');
            const billingText = document.getElementById('billingDisplayText');

            if (billingDropdown && billingDisplay && billingOptions && billingText) {
                console.log('✅ Initializing billing display dropdown');
                initializeSpecificDropdown(billingDropdown, billingDisplay, billingOptions, billingText, 'billingDisplay');
            }

            // Initialize payment method dropdown
            const paymentDropdown = document.getElementById('paymentMethodDropdown');
            const paymentDisplay = document.getElementById('paymentMethodDisplay');
            const paymentOptions = document.getElementById('paymentMethodOptions');
            const paymentText = document.getElementById('paymentMethodText');

            if (paymentDropdown && paymentDisplay && paymentOptions && paymentText) {
                console.log('✅ Initializing payment method dropdown');
                initializeSpecificDropdown(paymentDropdown, paymentDisplay, paymentOptions, paymentText, 'paymentMethod');
            }

            // Initialize invoice preview
            initializeInvoicePreview();
        }

        function initializeInvoicePreview() {
            // Update preview whenever relevant data changes
            updateInvoicePreview();

            // Set up listeners for real-time updates
            setupInvoicePreviewListeners();

            console.log('✅ Invoice preview initialized');
        }

        function setupInvoicePreviewListeners() {
            // Listen for dropdown changes
            const originalSelectOption = window.selectOption;

            // Override the existing selectOption function to trigger preview updates
            // This will be called from within initializeSpecificDropdown
            const updatePreviewFields = ['institutionSize', 'billingDisplay'];

            // We'll add a global listener that watches for changes in form state
            const checkForUpdates = setInterval(() => {
                if (window.lastPreviewState !== JSON.stringify({
                    institutionSize: formState.institutionSize,
                    billingDisplay: formState.billingDisplay,
                    attendingCount: teamState.attendingContacts?.size || 0
                })) {
                    updateInvoicePreview();
                    window.lastPreviewState = JSON.stringify({
                        institutionSize: formState.institutionSize,
                        billingDisplay: formState.billingDisplay,
                        attendingCount: teamState.attendingContacts?.size || 0
                    });
                }
            }, 500);
        }

        function updateInvoicePreview() {
            const previewElement = document.querySelector('[data-field="invoicePreview"] .field-display');
            if (!previewElement) return;

            const preview = generateInvoicePreview();
            previewElement.innerHTML = preview;

            // Add click handler and hover effects to preview
            const invoicePreviewDiv = previewElement.querySelector('.invoice-preview');
            if (invoicePreviewDiv) {
                invoicePreviewDiv.onclick = openInvoiceModal;

                let hoverTimeout;
                const hoverOverlay = invoicePreviewDiv.querySelector('.hover-overlay');

                invoicePreviewDiv.addEventListener('mouseenter', () => {
                    hoverTimeout = setTimeout(() => {
                        if (hoverOverlay) {
                            hoverOverlay.style.opacity = '1';
                        }
                    }, 1000); // Show after 1 second
                });

                invoicePreviewDiv.addEventListener('mouseleave', () => {
                    clearTimeout(hoverTimeout);
                    if (hoverOverlay) {
                        hoverOverlay.style.opacity = '0';
                    }
                });
            }
        }

        function generateInvoicePreview() {
            // Pricing structure
            const membershipPricing = {
                'XSmall': 420,
                'Small': 525,
                'Medium': 735,
                'Large': 895,
                'XLarge': 1000
            };

            const conferencePerPerson = 325;
            const hstRate = 0.13; // Ontario HST

            // Get current selections
            const institutionSize = formState.institutionSize;
            const billingDisplay = formState.billingDisplay;
            const attendingCount = teamState.attendingContacts?.size || 0;

            // Calculate amounts
            const membershipFee = membershipPricing[institutionSize] || 0;
            const conferenceTotal = attendingCount * conferencePerPerson;
            const conferenceHST = conferenceTotal * hstRate;
            const subtotal = membershipFee + conferenceTotal;
            const totalWithHST = membershipFee + conferenceTotal + conferenceHST;

            // Generate preview based on billing display choice
            let preview = '<div class="invoice-preview"><div class="hover-overlay">Click to confirm details</div>';

            if (!institutionSize) {
                preview += '<div class="preview-placeholder">Complete Step 1 to see pricing</div>';
            } else if (billingDisplay === 'single-item') {
                preview += `
                    <div class="invoice-line-item">
                        <span class="item-description">2025-2026 CSC Membership</span>
                        <span class="item-amount">$${totalWithHST.toFixed(2)}</span>
                    </div>
                    <div class="invoice-total">
                        <strong>Total: $${totalWithHST.toFixed(2)}</strong>
                    </div>
                `;
            } else if (billingDisplay === 'membership-conference') {
                preview += `
                    <div class="invoice-line-item">
                        <span class="item-description">Membership</span>
                        <span class="item-amount">$${membershipFee.toFixed(2)}</span>
                    </div>
                    <div class="invoice-line-item">
                        <span class="item-description">Conference Registration</span>
                        <span class="item-amount">$${conferenceTotal.toFixed(2)}</span>
                    </div>
                    <div class="invoice-subtotal">
                        Subtotal: $${subtotal.toFixed(2)}
                    </div>
                    ${conferenceHST > 0 ? `
                        <div class="invoice-tax">
                            HST (13%): $${conferenceHST.toFixed(2)}
                        </div>
                    ` : ''}
                    <div class="invoice-total">
                        <strong>Total: $${totalWithHST.toFixed(2)}</strong>
                    </div>
                `;
            } else if (billingDisplay === 'individual-line-items') {
                preview += `
                    <div class="invoice-line-item">
                        <span class="item-description">2025-2026 CSC Membership (${institutionSize})</span>
                        <span class="item-amount">$${membershipFee.toFixed(2)}</span>
                    </div>
                `;

                // Add individual conference registrations for each attending contact
                const attendingContacts = organizationContacts.filter(contact =>
                    teamState.attendingContacts.has(contact.id)
                );

                attendingContacts.forEach(contact => {
                    preview += `
                        <div class="invoice-line-item">
                            <span class="item-description">Conference Registration</span>
                            <span class="item-amount">$${conferencePerPerson.toFixed(2)}</span>
                        </div>
                        <div class="invoice-line-subitem">
                            ${contact.name}
                        </div>
                    `;
                });

                preview += `
                    <div class="invoice-subtotal">
                        Subtotal: $${subtotal.toFixed(2)}
                    </div>
                    ${conferenceHST > 0 ? `
                        <div class="invoice-tax">
                            HST (13%): $${conferenceHST.toFixed(2)}
                        </div>
                    ` : ''}
                    <div class="invoice-total">
                        <strong>Total: $${totalWithHST.toFixed(2)}</strong>
                    </div>
                `;
            } else {
                preview += '<div class="preview-placeholder">Select billing format to see preview</div>';
            }

            preview += '</div>';
            return preview;
        }

        function openInvoiceModal() {
            if (!formState.institutionSize) {
                alert('Please complete Step 1 first to generate invoice preview.');
                return;
            }

            const modal = createInvoiceModal();
            document.body.appendChild(modal);
            modal.classList.add('active');

            console.log('📄 Invoice modal opened');
        }

        function createInvoiceModal() {
            const modal = document.createElement('div');
            modal.className = 'invoice-modal';
            modal.id = 'invoiceModal';

            const currentDate = new Date().toLocaleDateString('en-CA');
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            const dueDateFormatted = dueDate.toLocaleDateString('en-CA');

            modal.innerHTML = `
                <div class="invoice-modal-container">
                    <div class="invoice-modal-content">
                        <div class="invoice-document">
                            ${generateFullInvoiceHTML(currentDate, dueDateFormatted)}
                        </div>
                        <div class="invoice-modal-actions">
                            <button class="invoice-btn secondary" onclick="closeInvoiceModal()">Make Changes</button>
                            <button class="invoice-btn primary" onclick="confirmInvoicePreview()">Proceed with Invoice</button>
                        </div>
                    </div>
                </div>
            `;

            return modal;
        }

        function generateFullInvoiceHTML(currentDate, dueDate) {
            const membershipPricing = {
                'XSmall': 420, 'Small': 525, 'Medium': 735, 'Large': 895, 'XLarge': 1000
            };

            const conferencePerPerson = 325;
            const hstRate = 0.13;

            const institutionSize = formState.institutionSize;
            const billingDisplay = formState.billingDisplay;
            const attendingCount = teamState.attendingContacts?.size || 0;

            const membershipFee = membershipPricing[institutionSize] || 0;
            const conferenceTotal = attendingCount * conferencePerPerson;
            const conferenceHST = conferenceTotal * hstRate;
            const subtotal = membershipFee + conferenceTotal;
            const totalWithHST = membershipFee + conferenceTotal + conferenceHST;

            // Get organization info from form state
            const orgName = formState.institutionName || 'Organization Name';
            const orgAddress = formState.address || '';

            // Get primary contact
            const primaryContact = organizationContacts.find(c => c.isPrimaryContact);
            const contactName = primaryContact?.name || 'Primary Contact';

            let lineItems = '';

            if (billingDisplay === 'single-item') {
                lineItems = `
                    <tr>
                        <td class="desc-col">2025-2026 CSC Membership</td>
                        <td class="qty-col">1</td>
                        <td class="price-col">C$${totalWithHST.toFixed(2)}</td>
                        <td class="amount-col">C$${totalWithHST.toFixed(2)}</td>
                    </tr>
                `;
            } else if (billingDisplay === 'membership-conference') {
                lineItems = `
                    <tr>
                        <td class="desc-col">2025-2026 CSC Membership</td>
                        <td class="qty-col">1</td>
                        <td class="price-col">C$${membershipFee.toFixed(2)}</td>
                        <td class="amount-col">C$${membershipFee.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td class="desc-col">Conference Registration</td>
                        <td class="qty-col">${attendingCount}</td>
                        <td class="price-col">C$${conferencePerPerson.toFixed(2)}</td>
                        <td class="amount-col">C$${conferenceTotal.toFixed(2)}</td>
                    </tr>
                `;
            } else if (billingDisplay === 'individual-line-items') {
                lineItems = `
                    <tr>
                        <td class="desc-col">2025-2026 CSC Membership (${institutionSize})</td>
                        <td class="qty-col">1</td>
                        <td class="price-col">C$${membershipFee.toFixed(2)}</td>
                        <td class="amount-col">C$${membershipFee.toFixed(2)}</td>
                    </tr>
                `;

                const attendingContacts = organizationContacts.filter(contact =>
                    teamState.attendingContacts.has(contact.id)
                );

                attendingContacts.forEach(contact => {
                    lineItems += `
                        <tr>
                            <td class="desc-col">Conference Registration - ${contact.name}</td>
                            <td class="qty-col">1</td>
                            <td class="price-col">C$${conferencePerPerson.toFixed(2)}</td>
                            <td class="amount-col">C$${conferencePerPerson.toFixed(2)}</td>
                        </tr>
                    `;
                });
            }

            return `
                <div class="invoice-header">
                    <div class="invoice-left">
                        <img src="https://images.squarespace-cdn.com/content/v1/5ec55d5d28a93e0e18d2eeb4/1600096854522-HS7NUI12I1ML6SPJFLLY/Artboard+1.png?format=1500w" alt="Campus Stores Canada" class="csc-logo">
                        <div class="csc-info">
                            <div>Campus Stores Canada</div>
                            <div>PO Box 7157 Silver Springs</div>
                            <div>Calgary, Alberta T3B 5K2</div>
                            <div>Canada</div>
                            <div>+1 888-288-4044</div>
                            <div>info@campusstores.ca</div>
                        </div>
                    </div>
                    <div class="invoice-right">
                        <h1>Invoice</h1>
                        <div class="preview-watermark">PREVIEW ONLY</div>
                        <div class="invoice-details">
                            <div>Invoice number: PREVIEW</div>
                            <div>Date of Issue: ${currentDate}</div>
                            <div>Date due: ${dueDate}</div>
                        </div>
                    </div>
                </div>

                <div class="invoice-addresses">
                    <div class="bill-to">
                        <h3>Bill to</h3>
                        <div>${orgName}</div>
                        <div>${contactName}</div>
                        <div>${orgAddress}</div>
                    </div>
                </div>

                <div class="amount-due">
                    <strong>C$${totalWithHST.toFixed(2)} due ${dueDate}</strong>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th class="desc-col">Description</th>
                            <th class="qty-col">Qty</th>
                            <th class="price-col">Unit price</th>
                            <th class="amount-col">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${lineItems}
                    </tbody>
                </table>

                <div class="invoice-totals">
                    <div class="totals-row">
                        <span>Subtotal</span>
                        <span>C$${subtotal.toFixed(2)}</span>
                    </div>
                    ${conferenceHST > 0 ? `
                        <div class="totals-row">
                            <span>HST (13%)</span>
                            <span>C$${conferenceHST.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    <div class="totals-row total-row">
                        <span><strong>Total</strong></span>
                        <span><strong>C$${totalWithHST.toFixed(2)}</strong></span>
                    </div>
                    <div class="totals-row amount-due-row">
                        <span><strong>Amount due</strong></span>
                        <span><strong>C$${totalWithHST.toFixed(2)}</strong></span>
                    </div>
                </div>

                <div class="invoice-footer">
                    <div class="csc-footer">
                        Campus Stores Canada<br>
                        PO Box 7157 Silver Springs, Calgary, AB, Canada T3B 5K2
                    </div>
                </div>
            `;
        }

        function closeInvoiceModal() {
            const modal = document.getElementById('invoiceModal');
            if (modal) {
                modal.remove();
            }
            console.log('📄 Invoice modal closed - returning to form');
        }

        async function confirmInvoicePreview() {
            // Mark invoice as confirmed
            window.invoiceConfirmed = true;

            // Show sync progress
            const modal = document.getElementById('invoiceModal');
            let actions = null;
            if (modal) {
                actions = modal.querySelector('.invoice-modal-actions');
                if (actions) {
                    actions.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px;">
                            <div style="width: 20px; height: 20px; border: 2px solid #ba003b; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="color: #666; font-size: 14px;">Saving your information...</span>
                        </div>
                    `;
                }
            }

            try {
                // Sync all changes to Notion
                await syncMembershipRenewal();

                // Update progress message
                if (modal && actions) {
                    actions.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px;">
                            <div style="width: 20px; height: 20px; border: 2px solid #ba003b; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="color: #666; font-size: 14px;">Creating QuickBooks invoice...</span>
                        </div>
                    `;
                }

                // Create QuickBooks invoice
                await createQuickBooksInvoice();

                // Enable next step button
                const nextButton = document.querySelector('.next-btn');
                if (nextButton) {
                    nextButton.disabled = false;
                    nextButton.classList.remove('disabled');
                }

                // Close modal and show success
                closeInvoiceModal();
                console.log('✅ Membership renewal completed - Notion synced, QuickBooks invoice created');

            } catch (error) {
                console.error('❌ Sync failed:', error);

                // Show error in modal
                if (modal && actions) {
                    actions.innerHTML = `
                        <div style="text-align: center; padding: 16px;">
                            <div style="color: #dc3545; margin-bottom: 12px; font-weight: 600;">⚠️ Sync Error</div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 16px;">
                                Your data couldn't be saved automatically, but has been logged for manual processing.
                            </div>
                            <button class="invoice-btn primary" onclick="closeInvoiceModal(); proceedAnyway();">Continue Anyway</button>
                            <button class="invoice-btn secondary" onclick="location.reload()">Refresh & Try Again</button>
                        </div>
                    `;
                }
            }
        }

        // Sync all membership renewal data to Notion
        async function syncMembershipRenewal() {
            console.log('🚀 Starting membership renewal sync...');

            // Get token from URL parameters
            const token = new URLSearchParams(window.location.search).get('token');

            // Gather all local changes
            const syncData = {
                organizationUpdates: gatherOrganizationUpdates(),
                contactOperations: gatherContactOperations()
            };

            console.log('📦 Sync data prepared:', syncData);

            // Send to batch sync API
            const response = await fetch('/api/sync-membership-renewal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    token: token,
                    syncData: syncData
                })
            });

            const result = await response.json();

            if (!response.ok || result.hasErrors) {
                console.error('❌ Sync failed or had errors:', result);
                throw new Error(result.message || 'Sync failed');
            }

            console.log('✅ Sync completed successfully:', result);
            return result;
        }

        // Gather organization changes from formState
        function gatherOrganizationUpdates() {
            const updates = {};

            // Check if organization fields have changed from initial values
            if (formState.institutionName && formState.institutionName !== window.initialFormState?.institutionName) {
                updates.institutionName = formState.institutionName;
            }

            if (formState.website && formState.website !== window.initialFormState?.website) {
                updates.website = formState.website;
            }

            if (formState.institutionSize && formState.institutionSize !== window.initialFormState?.institutionSize) {
                updates.institutionSize = formState.institutionSize;
            }

            // Check address changes
            const currentAddress = formState.address || {
                streetAddress: formState.streetAddress,
                city: formState.city,
                province: formState.province,
                postalCode: formState.postalCode
            };

            const initialAddress = window.initialFormState?.address || {
                streetAddress: window.initialFormState?.streetAddress,
                city: window.initialFormState?.city,
                province: window.initialFormState?.province,
                postalCode: window.initialFormState?.postalCode
            };

            if (JSON.stringify(currentAddress) !== JSON.stringify(initialAddress)) {
                updates.address = currentAddress;
            }

            console.log('🏢 Organization updates:', updates);
            return Object.keys(updates).length > 0 ? updates : null;
        }

        // Gather contact operations from teamState
        function gatherContactOperations() {
            const operations = {
                create: [],
                update: [],
                delete: [],
                conferenceTeam: []
            };

            // New contacts
            if (teamState.newContacts && teamState.newContacts.length > 0) {
                operations.create = teamState.newContacts.map(contact => ({
                    name: contact.name,
                    firstName: contact.firstName,
                    workEmail: contact.workEmail,
                    workPhone: contact.workPhone,
                    roleTitle: contact.roleTitle,
                    dietaryRestrictions: contact.dietaryRestrictions
                }));
            }

            // Updated contacts
            if (teamState.editedContacts) {
                Object.keys(teamState.editedContacts).forEach(contactId => {
                    const editedData = teamState.editedContacts[contactId];
                    operations.update.push({
                        originalId: contactId,
                        name: editedData.name,
                        workEmail: editedData.email,
                        workPhone: editedData.phone,
                        roleTitle: editedData.title,
                        dietaryRestrictions: editedData.dietary
                    });
                });
            }

            // Deleted contacts
            if (teamState.deletedContacts && teamState.deletedContacts.length > 0) {
                operations.delete = [...teamState.deletedContacts];
            }

            // Conference team (attendance and primary contact status)
            if (organizationContacts && organizationContacts.length > 0) {
                organizationContacts.forEach(contact => {
                    const isAttending = teamState.attendingContacts ? teamState.attendingContacts.has(contact.id) : false;
                    const isPrimary = contact.isPrimaryContact || false;

                    operations.conferenceTeam.push({
                        id: contact.id,
                        attending: isAttending,
                        isPrimary: isPrimary
                    });
                });
            }

            console.log('👥 Contact operations:', operations);
            return operations;
        }

        // Create QuickBooks Online invoice
        async function createQuickBooksInvoice() {
            console.log('💰 Creating QuickBooks invoice...');

            // Get token from URL parameters
            const token = new URLSearchParams(window.location.search).get('token');

            // Gather invoice data
            const invoiceData = prepareInvoiceData();
            const organizationData = prepareOrganizationData();
            const billingPreferences = prepareBillingPreferences();

            console.log('📊 Invoice data prepared for QBO:', {
                organization: organizationData.name,
                total: invoiceData.total,
                billingDisplay: billingPreferences.billingDisplay
            });

            // Call QBO API
            const response = await fetch('/api/create-qbo-invoice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    token: token,
                    organizationData: organizationData,
                    invoiceData: invoiceData,
                    billingPreferences: billingPreferences
                })
            });

            const result = await response.json();

            if (!response.ok) {
                console.error('❌ QuickBooks invoice creation failed:', result);
                throw new Error(result.message || 'QuickBooks invoice creation failed');
            }

            console.log('✅ QuickBooks invoice created:', result);

            // Store QBO info for potential future use
            window.qboInvoiceResult = result;

            return result;
        }

        // Prepare invoice data for QuickBooks
        function prepareInvoiceData() {
            const membershipPricing = {
                'XSmall': 420,
                'Small': 525,
                'Medium': 735,
                'Large': 895,
                'XLarge': 1000
            };

            const membershipFee = membershipPricing[formState.institutionSize] || 0;
            const attendingCount = teamState.attendingContacts?.size || 0;
            const conferenceRegistrationFee = 325;
            const conferenceTotal = attendingCount * conferenceRegistrationFee;
            const hstRate = 0.13;
            const conferenceHST = conferenceTotal * hstRate;
            const total = membershipFee + conferenceTotal + conferenceHST;

            return {
                membershipFee,
                conferenceTotal,
                conferenceHST,
                attendingCount,
                total,
                institutionSize: formState.institutionSize
            };
        }

        // Prepare organization data for QuickBooks
        function prepareOrganizationData() {
            // Get primary contact
            const primaryContact = organizationContacts?.find(contact => contact.isPrimaryContact);

            return {
                name: formState.institutionName,
                website: formState.website,
                address: formState.address,
                primaryContact: primaryContact ? {
                    name: primaryContact.name,
                    workEmail: primaryContact.workEmail,
                    workPhone: primaryContact.workPhone
                } : null
            };
        }

        // Prepare billing preferences for QuickBooks
        function prepareBillingPreferences() {
            return {
                billingDisplay: formState.billingDisplay || 'individual-line-items',
                paymentMethod: formState.paymentMethod || 'pay-now'
            };
        }

        // Allow user to proceed despite sync errors
        function proceedAnyway() {
            const nextButton = document.querySelector('.next-btn');
            if (nextButton) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled');
            }
            console.log('⚠️ User chose to proceed despite sync errors');
        }

        // Field configurations
        const fieldConfigs = {
            // Step 1 fields (38vw width)
            institutionName: {
                label: 'Institution name',
                type: 'input',
                inputClass: 'institution-name',
                placeholder: 'Enter institution name',
                maxLength: 100,
                required: true,
                width: '38vw'
            },
            website: {
                label: 'Website',
                type: 'input',
                inputClass: 'website',
                placeholder: 'example.com',
                required: false,
                width: '38vw'
            },
            description: {
                label: 'Company description',
                type: 'textarea',
                inputClass: 'description',
                placeholder: 'Give our members an elevator pitch of who you are.',
                maxLength: 300,
                required: false,
                width: '38vw'
            },
            // Step 2 fields (22vw width)
            highlightHeadline: {
                label: 'Headline',
                type: 'input',
                inputClass: 'headline',
                placeholder: 'Give your product or service a catchy headline',
                maxLength: 100,
                required: false,
                width: '22vw'
            },
            highlightDescription: {
                label: 'Description',
                type: 'textarea',
                inputClass: 'highlight-description',
                placeholder: 'Give a short description of what you are going to do for the members, not every carve out and caveat, but the gist.',
                maxLength: 300,
                required: false,
                width: '22vw'
            },
            highlightDeal: {
                label: 'Conference special',
                type: 'input',
                inputClass: 'deal',
                placeholder: "What's your conference special? Free consultation? Discount? Bonus swag?",
                maxLength: 200,
                required: false,
                width: '22vw'
            },
            address: {
                label: 'Address',
                type: 'address',
                required: false,
                width: '38vw',
                fields: {
                    streetAddress: {
                        label: 'Street Address',
                        placeholder: 'Enter street address',
                        maxLength: 100
                    },
                    city: {
                        label: 'City',
                        placeholder: 'Enter city',
                        maxLength: 50
                    },
                    province: {
                        label: 'Province',
                        placeholder: 'Select province',
                        type: 'select'
                    },
                    postalCode: {
                        label: 'Postal Code',
                        placeholder: 'Enter postal code',
                        maxLength: 7
                    }
                }
            }
        };

        // ===========================================
        // FIELD EDITING FUNCTIONS
        // ===========================================
        function editField(fieldName) {
            if (fieldName === 'category') {
                return;
            }
            
            if (activeField && activeField !== fieldName) {
                closeField(activeField);
            }

            activeField = fieldName;
            const fieldElement = document.querySelector(`[data-field="${fieldName}"]`);
            const displayElement = document.getElementById(`${fieldName}Display`);
            const editButton = document.getElementById(`edit${capitalizeFirst(fieldName)}`);
            
            const displayRect = displayElement.getBoundingClientRect();
            const fieldRect = fieldElement.getBoundingClientRect();
            
            const relativeTop = displayRect.top - fieldRect.top;
            const relativeLeft = displayRect.left - fieldRect.left;
            
            displayElement.style.opacity = '0';
            editButton.style.opacity = '0';
            
            createFieldOverlay(fieldName, relativeLeft, relativeTop, displayRect.width, displayRect.height);
            
            console.log('📝 Editing field:', fieldName);
        }

        function closeField(fieldName) {
            removeFieldOverlay(fieldName);
            
            const displayElement = document.getElementById(`${fieldName}Display`);
            const editButton = document.getElementById(`edit${capitalizeFirst(fieldName)}`);
            
            if (displayElement) displayElement.style.opacity = '1';
            if (editButton) editButton.style.opacity = '1';
        }

        function createFieldOverlay(fieldName, x, y, width, height) {
            const fieldElement = document.querySelector(`[data-field="${fieldName}"]`);
            const config = fieldConfigs[fieldName];

            // Handle address field specially
            if (config.type === 'address') {
                createAddressOverlay(fieldName, x, y, width, height);
                return;
            }

            const overlay = document.createElement('div');
            overlay.className = 'field-overlay active';
            overlay.id = `overlay-${fieldName}`;

            const border = document.createElement('div');
            border.className = 'field-border';

            const label = document.createElement('div');
            label.className = 'field-label';
            label.textContent = config.label;

            const inputContainer = document.createElement('div');
            inputContainer.className = 'field-input-container';

            let inputElement;
            if (config.type === 'textarea') {
                inputElement = document.createElement('textarea');
                inputElement.className = `field-textarea ${config.inputClass}`;
                inputElement.maxLength = config.maxLength || 1000;
            } else {
                inputElement = document.createElement('input');
                inputElement.className = `field-input ${config.inputClass}`;
                inputElement.type = fieldName === 'website' ? 'url' : 'text';
                if (config.maxLength) {
                    inputElement.maxLength = config.maxLength;
                }
            }

            inputElement.placeholder = config.placeholder;
            inputElement.value = formState[fieldName] || '';

            // Use the width from config (22vw for Step 2, 38vw for Step 1)
            const fieldWidth = config.width || '38vw';
            inputContainer.style.left = x + 'px';
            inputContainer.style.top = y + 'px';
            inputContainer.style.width = fieldWidth;

            if (config.type === 'textarea') {
                inputContainer.style.height = Math.max(height, 120) + 'px';
            } else {
                inputContainer.style.height = height + 'px';
            }

            const padding = 16;
            // Calculate border width based on the field's specific width
            const fieldWidthPercent = parseFloat(fieldWidth) / 100; // Convert 22vw to 0.22
            const inputWidthVw = window.innerWidth * fieldWidthPercent;
            const borderWidth = inputWidthVw + (padding * 2);

            border.style.left = (x - padding) + 'px';
            border.style.top = (y - padding) + 'px';
            border.style.width = borderWidth + 'px';

            if (config.type === 'textarea') {
                border.style.height = (Math.max(height, 120) + padding * 2) + 'px';
            } else {
                border.style.height = (height + padding * 2) + 'px';
            }
            
            label.style.left = (x - padding + 12) + 'px';
            label.style.top = (y - padding - 9) + 'px';
            
            if (config.maxLength) {
                const counter = document.createElement('div');
                counter.className = 'character-counter';
                counter.id = `charCounter-${fieldName}`;
                
                counter.textContent = config.maxLength - (formState[fieldName] || '').length;
                
                const borderHeight = config.type === 'textarea' ? Math.max(height, 120) + padding * 2 : height + padding * 2;
                counter.style.position = 'absolute';
                counter.style.right = (x - padding + 24) + 'px';
                counter.style.top = (y - padding + borderHeight - 9) + 'px';
                counter.style.background = '#ffffff';
                counter.style.padding = '0 0.4vw';
                counter.style.zIndex = '1';
                
                overlay.appendChild(counter);
                
                inputElement.addEventListener('input', () => updateCharCounter(fieldName));
            }
            
            inputContainer.appendChild(inputElement);
            overlay.appendChild(border);
            overlay.appendChild(label);
            overlay.appendChild(inputContainer);
            
            fieldElement.appendChild(overlay);
            
            requestAnimationFrame(() => {
                inputElement.focus();
                if (inputElement.select) inputElement.select();
            });
            
            setupInputEventListeners(inputElement, fieldName);
        }

        function setupInputEventListeners(inputElement, fieldName) {
            inputElement.addEventListener('blur', () => {
                if (activeField === fieldName) {
                    saveField(fieldName);
                }
            });

            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && fieldConfigs[fieldName].type !== 'textarea') {
                    inputElement.blur();
                } else if (e.key === 'Escape') {
                    cancelEdit(fieldName);
                }
            });
        }

        function createAddressOverlay(fieldName, x, y, width, height) {
            const fieldElement = document.querySelector(`[data-field="${fieldName}"]`);
            const config = fieldConfigs[fieldName];

            const overlay = document.createElement('div');
            overlay.className = 'field-overlay active';
            overlay.id = `overlay-${fieldName}`;

            const border = document.createElement('div');
            border.className = 'field-border';

            const label = document.createElement('div');
            label.className = 'field-label';
            label.textContent = config.label;

            const formContainer = document.createElement('div');
            formContainer.className = 'address-form-container';

            // Calculate dimensions for address form
            const fieldWidth = config.width || '38vw';
            const padding = 16;
            const fieldWidthPercent = parseFloat(fieldWidth) / 100;
            const inputWidthVw = window.innerWidth * fieldWidthPercent;
            const borderWidth = inputWidthVw + (padding * 2);

            // Calculate form height dynamically:
            // 2 rows (street address + city/province/postal) * 60px + 48px (button row + margins) + 20px extra padding
            const fieldRowHeight = 60; // Estimated height per field row
            const buttonRowHeight = 48; // Height for button row
            const extraPadding = 20; // Extra padding for spacing
            const formHeight = (2 * fieldRowHeight) + buttonRowHeight + extraPadding;

            // Position form container
            formContainer.style.left = x + 'px';
            formContainer.style.top = y + 'px';
            formContainer.style.width = fieldWidth;
            formContainer.style.height = formHeight + 'px';

            // Position border to encompass the entire form including buttons
            const borderHeight = formHeight + (padding * 2);
            border.style.left = (x - padding) + 'px';
            border.style.top = (y - padding) + 'px';
            border.style.width = borderWidth + 'px';
            border.style.height = borderHeight + 'px';

            // Position label
            label.style.left = (x - padding + 12) + 'px';
            label.style.top = (y - padding - 9) + 'px';

            // Create address form fields
            const addressData = formState.address || {};

            // Street Address field (full width)
            const streetFieldConfig = config.fields.streetAddress;
            const streetFieldRow = document.createElement('div');
            streetFieldRow.className = 'address-field-row';

            const streetFieldLabel = document.createElement('label');
            streetFieldLabel.className = 'address-field-label';
            streetFieldLabel.textContent = streetFieldConfig.label;

            const streetFieldInput = document.createElement('input');
            streetFieldInput.className = 'address-field-input';
            streetFieldInput.type = 'text';
            streetFieldInput.placeholder = streetFieldConfig.placeholder;
            streetFieldInput.value = addressData.streetAddress || '';
            streetFieldInput.dataset.addressField = 'streetAddress';

            streetFieldRow.appendChild(streetFieldLabel);
            streetFieldRow.appendChild(streetFieldInput);
            formContainer.appendChild(streetFieldRow);

            // City/Province/Postal Code row
            const locationFieldRow = document.createElement('div');
            locationFieldRow.className = 'address-field-row address-location-row';

            // City field
            const cityFieldConfig = config.fields.city;
            const cityContainer = document.createElement('div');
            cityContainer.className = 'address-city-container';

            const cityFieldLabel = document.createElement('label');
            cityFieldLabel.className = 'address-field-label';
            cityFieldLabel.textContent = cityFieldConfig.label;

            const cityFieldInput = document.createElement('input');
            cityFieldInput.className = 'address-field-input';
            cityFieldInput.type = 'text';
            cityFieldInput.placeholder = cityFieldConfig.placeholder;
            cityFieldInput.value = addressData.city || '';
            cityFieldInput.dataset.addressField = 'city';

            cityContainer.appendChild(cityFieldLabel);
            cityContainer.appendChild(cityFieldInput);

            // Province field
            const provinceFieldConfig = config.fields.province;
            const provinceContainer = document.createElement('div');
            provinceContainer.className = 'address-province-container';

            const provinceFieldLabel = document.createElement('label');
            provinceFieldLabel.className = 'address-field-label';
            provinceFieldLabel.textContent = provinceFieldConfig.label;

            const provinceFieldInput = document.createElement('select');
            provinceFieldInput.className = 'address-field-select';
            provinceFieldInput.dataset.addressField = 'province';

            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select province';
            provinceFieldInput.appendChild(defaultOption);

            // Add province options from vendorData
            if (window.vendorData && window.vendorData.provinceOptions) {
                window.vendorData.provinceOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.label;
                    provinceFieldInput.appendChild(optionElement);
                });
            }

            // Set current province value
            const currentProvince = addressData.province || '';
            provinceFieldInput.value = currentProvince;

            provinceContainer.appendChild(provinceFieldLabel);
            provinceContainer.appendChild(provinceFieldInput);

            // Postal Code field
            const postalFieldConfig = config.fields.postalCode;
            const postalContainer = document.createElement('div');
            postalContainer.className = 'address-postal-container';

            const postalFieldLabel = document.createElement('label');
            postalFieldLabel.className = 'address-field-label';
            postalFieldLabel.textContent = postalFieldConfig.label;

            const postalFieldInput = document.createElement('input');
            postalFieldInput.className = 'address-field-input';
            postalFieldInput.type = 'text';
            postalFieldInput.placeholder = postalFieldConfig.placeholder;
            postalFieldInput.value = addressData.postalCode || '';
            if (postalFieldConfig.maxLength) {
                postalFieldInput.maxLength = postalFieldConfig.maxLength;
            }
            postalFieldInput.dataset.addressField = 'postalCode';

            postalContainer.appendChild(postalFieldLabel);
            postalContainer.appendChild(postalFieldInput);

            // Add all containers to the location row
            locationFieldRow.appendChild(cityContainer);
            locationFieldRow.appendChild(provinceContainer);
            locationFieldRow.appendChild(postalContainer);
            formContainer.appendChild(locationFieldRow);

            // Focus first field
            requestAnimationFrame(() => streetFieldInput.focus());

            // Add save/cancel buttons
            const buttonRow = document.createElement('div');
            buttonRow.className = 'address-button-row';
            buttonRow.style.marginTop = '16px';
            buttonRow.style.display = 'flex';
            buttonRow.style.gap = '8px';

            const saveButton = document.createElement('button');
            saveButton.className = 'address-save-btn';
            saveButton.textContent = 'Save';
            saveButton.style.padding = '8px 16px';
            saveButton.style.backgroundColor = '#ba003b';
            saveButton.style.color = 'white';
            saveButton.style.border = 'none';
            saveButton.style.borderRadius = '4px';
            saveButton.style.cursor = 'pointer';

            const cancelButton = document.createElement('button');
            cancelButton.className = 'address-cancel-btn';
            cancelButton.textContent = 'Cancel';
            cancelButton.style.padding = '8px 16px';
            cancelButton.style.backgroundColor = '#ccc';
            cancelButton.style.color = '#333';
            cancelButton.style.border = 'none';
            cancelButton.style.borderRadius = '4px';
            cancelButton.style.cursor = 'pointer';

            buttonRow.appendChild(saveButton);
            buttonRow.appendChild(cancelButton);
            formContainer.appendChild(buttonRow);

            overlay.appendChild(border);
            overlay.appendChild(label);
            overlay.appendChild(formContainer);
            fieldElement.appendChild(overlay);

            // Event listeners
            saveButton.addEventListener('click', () => saveAddressField());
            cancelButton.addEventListener('click', () => cancelEdit(fieldName));

            // Handle Enter/Escape keys
            formContainer.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.tagName !== 'SELECT') {
                    saveAddressField();
                } else if (e.key === 'Escape') {
                    cancelEdit(fieldName);
                }
            });

            function saveAddressField() {
                const addressData = {};
                const inputs = formContainer.querySelectorAll('[data-address-field]');

                inputs.forEach(input => {
                    const fieldKey = input.dataset.addressField;
                    addressData[fieldKey] = input.value;
                });

                formState.address = addressData;
                updateAddressDisplay();
                removeFieldOverlay(fieldName);

                const displayElement = document.getElementById('addressDisplay');
                const editButton = document.getElementById('editAddress');
                if (displayElement) displayElement.style.opacity = '1';
                if (editButton) editButton.style.opacity = '1';

                activeField = null;
            }
        }

        function saveField(fieldName) {
            const overlay = document.getElementById(`overlay-${fieldName}`);
            if (!overlay) return;
            
            const inputElement = overlay.querySelector('input, select, textarea');
            const newValue = inputElement.value;
            
            if (fieldName === 'category' && !newValue) {
                inputElement.focus();
                return;
            }
            
            const errorMessage = validateField(fieldName, newValue);
            
            if (errorMessage) {
                showFieldError(fieldName, errorMessage);
                return;
            }
            
            clearFieldError(fieldName);
            
            formState[fieldName] = newValue;
            updateFieldDisplay(fieldName, newValue);
            removeFieldOverlay(fieldName);
            
            const displayElement = document.getElementById(`${fieldName}Display`);
            const editButton = document.getElementById(`edit${capitalizeFirst(fieldName)}`);
            displayElement.style.opacity = '1';
            editButton.style.opacity = '1';
            
            activeField = null;
            
            console.log('📝 Updated field:', fieldName, '=', newValue);
        }

        function cancelEdit(fieldName) {
            closeField(fieldName);
            activeField = null;
        }

        function removeFieldOverlay(fieldName) {
            const overlay = document.getElementById(`overlay-${fieldName}`);
            if (overlay) {
                overlay.remove();
            }
        }

        function updateFieldDisplay(fieldName, value) {
            if (fieldName === 'category') {
                const text = document.getElementById('categoryText');
                const display = document.getElementById('categoryDisplay');
                if (text && display) {
                    if (value) {
                        text.textContent = value;
                        display.classList.remove('placeholder');
                    } else {
                        text.textContent = 'Select your primary category';
                        display.classList.add('placeholder');
                    }
                }
                return;
            }
            
            const display = document.getElementById(`${fieldName}Display`);
            if (!display) return;
            
            const config = fieldConfigs[fieldName];
            
            if (value) {
                if (fieldName === 'website') {
                    let cleanUrl = value.replace(/^https?:\/\//, '').replace(/^www\./, '');
                    display.textContent = cleanUrl;
                } else {
                    display.textContent = value;
                }
                display.classList.remove('placeholder');
            } else {
                display.textContent = config.placeholder;
                display.classList.add('placeholder');
            }
        }

        function updateCharCounter(fieldName) {
            const counter = document.getElementById(`charCounter-${fieldName}`);
            const inputElement = document.querySelector(`#overlay-${fieldName} input, #overlay-${fieldName} textarea`);
            if (!counter || !inputElement) return;
            
            const config = fieldConfigs[fieldName];
            const remaining = config.maxLength - inputElement.value.length;
            
            counter.textContent = remaining;
            
            let warningThreshold;
            if (config.maxLength <= 100) {
                warningThreshold = 10;
            } else if (config.maxLength <= 200) {
                warningThreshold = 25;
            } else {
                warningThreshold = 75;
            }
            counter.className = remaining <= warningThreshold ? 'character-counter warning' : 'character-counter';
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // ===========================================
        // VALIDATION SYSTEM
        // ===========================================
        function validateField(fieldName, value) {
            const validators = {
                companyName: (val) => {
                    if (!val || val.trim().length === 0) {
                        return 'Company name is required';
                    }
                    if (val.length > 100) {
                        return 'Company name cannot exceed 100 characters';
                    }
                    return null;
                },
                
                category: (val) => {
                    if (!val || val.trim() === '') {
                        return 'Please select a category';
                    }
                    return null;
                },
                
                description: () => null,
                website: () => null,
                highlightHeadline: () => null,
                highlightDescription: () => null,
                highlightDeal: () => null
            };
            
            return validators[fieldName] ? validators[fieldName](value) : null;
        }

        function validateCategorySelection() {
            if (categoryDropdownOpen) {
                console.log('🔧 Skipping category validation - dropdown is open');
                return true;
            }
            
            const errorMessage = validateField('category', formState.category);
            
            if (errorMessage) {
                showCategoryError();
                return false;
            }
            
            clearCategoryError();
            return true;
        }
        
        function showCategoryError() {
            const dropdown = document.getElementById('categoryDisplay');
            dropdown.classList.add('error-state');
            dropdown.style.animation = 'errorPulse 1s ease-in-out infinite';
        }
        
        function clearCategoryError() {
            const dropdown = document.getElementById('categoryDisplay');
            dropdown.classList.remove('error-state');
            dropdown.style.animation = 'none';
            dropdown.offsetHeight;
        }

        function showFieldError(fieldName, message) {
            const overlay = document.getElementById(`overlay-${fieldName}`);
            if (!overlay) return;
            
            const border = overlay.querySelector('.field-border');
            if (border) {
                border.classList.add('error-state');
                border.style.animation = 'errorPulse 1s ease-in-out infinite';
            }
            
            let errorElement = overlay.querySelector('.error-message');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.className = 'error-message';
                overlay.appendChild(errorElement);
            }
            
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        function clearFieldError(fieldName) {
            const overlay = document.getElementById(`overlay-${fieldName}`);
            if (!overlay) return;
            
            const border = overlay.querySelector('.field-border');
            if (border) {
                border.classList.remove('error-state');
                border.style.animation = '';
            }
            
            const errorElement = overlay.querySelector('.error-message');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function validateAllFields() {
            let allValid = true;

            const institutionNameError = validateField('institutionName', formState.institutionName);
            if (institutionNameError) {
                console.log('❌ Institution name validation failed:', institutionNameError);
                allValid = false;
            }

            // Institution size is optional, no validation needed

            return allValid;
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('success') === 'true') {
                console.log('🎉 OAuth callback success!');
                showSuccessState();
                return;
            }
            
            if (urlParams.get('error')) {
                const error = urlParams.get('error');
                console.error('❌ OAuth callback error:', error);
                showErrorState(getErrorMessage(error));
                return;
            }
            
            const token = urlParams.get('token');
            if (!token) {
                showErrorState('Invalid access link. Please check your email for the correct URL.');
                return;
            }

            try {
                console.log('🪄 Loading vendor data for token:', token);
                await loadVendorData(token);
                initializeDropdown();
                showWelcomeScreen();
            } catch (error) {
                console.error('Error loading vendor data:', error);
                showErrorState('Unable to load your profile information. Please try again later.');
            }
        });

        // ===========================================
        // WIZARD NAVIGATION
        // ===========================================
        function startWizard() {
            currentStep = 1;
            showStep(currentStep);
            updateStepNavigation();
            updateMobileProgress(); // If this function exists
        }

        function nextStep() {
            if (activeField) {
                saveField(activeField);
                if (activeField) return;
            }

            if (!validateAllFields()) {
                return;
            }

            // Special check for step 3 (Billing) - require invoice confirmation
            if (currentStep === 3 && !window.invoiceConfirmed) {
                openInvoiceModal();
                return;
            }

            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
                updateStepNavigation();
                updateMobileProgress(); // If this function exists
            }
        }
        
        function previousStep() {
            if (activeField) {
                saveField(activeField);
            }
            
            if (currentStep > 0) {
                currentStep--;
                showStep(currentStep);
                updateStepNavigation();
                updateMobileProgress(); // If this function exists
            }
        }

        function showStep(stepNumber) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.remove('active'));
        
            if (stepNumber === 0) {
                document.getElementById('welcomeSection').classList.add('active');
            } else {
                document.getElementById(`step${stepNumber}Section`).classList.add('active');
                if (stepNumber === 2 && !initializedSteps.has(2)) {
                    initializeStep3(); // Contact Management (Campus store team)
                    initializedSteps.add(2);
                    console.log('🚀 Step 2 (Contact Management) initialized on first visit!');
                }
                if (stepNumber === 3 && !initializedSteps.has(3)) {
                    initializeStep2(); // This was the old Step 2 functionality (image upload, etc.)
                    initializedSteps.add(3);
                    console.log('🚀 Step 3 initialized on first visit!');
                }
                if (stepNumber === 4) {
                    if (!initializedSteps.has(4)) {
                        initializeStep4();
                        initializedSteps.add(4);
                        console.log('🚀 Step 4 initialized on first visit!');
                    } else {
                        // Repopulate the list in case attending status changed
                        populatePrimaryContactList();
                        console.log('🔄 Step 4 refreshed with updated attending list');
                    }
                }
                if (stepNumber === 5 && !initializedSteps.has(5)) {
                    initializeStep5();
                    initializedSteps.add(5);
                }
                if (stepNumber === 6 && !initializedSteps.has(6)) {
                    initializeStep6();
                    initializedSteps.add(6);
                }
            } 
                
        }

        function updateStepNavigation() {
            document.querySelectorAll('.step-item').forEach((item, index) => {
                item.classList.remove('active', 'completed');
                
                if (currentStep > 0) {
                    // Mark steps as completed if we've passed them
                    if (index < currentStep - 1) {
                        item.classList.add('completed');
                    }
                    // Mark current step as active
                    else if (index === currentStep - 1) {
                        item.classList.add('active');
                    }
                }
            });
        }

        function updateMobileProgress() {
            const progressFill = document.querySelector('.mobile-progress-fill');
            const progressPercent = ((currentStep - 1) / (totalSteps - 1)) * 100;
            progressFill.style.width = `${Math.max(0, progressPercent)}%`;
        }

        // ===========================================
        // STATE MANAGEMENT
        // ===========================================
        function showWelcomeScreen() {
            showStep(0);
            hideLoadingState();
            hideErrorState();
            hideSuccessState();
            document.getElementById('wizardContent').classList.add('loaded');
        }

        function showLoadingState() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('wizardContent').style.display = 'none';
            hideErrorState();
            hideSuccessState();
        }

        function hideLoadingState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('wizardContent').style.display = 'flex';
        }

        function showErrorState(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
            hideLoadingState();
            hideSuccessState();
        }

        function hideErrorState() {
            document.getElementById('errorState').style.display = 'none';
        }

        function showSuccessState() {
            document.getElementById('successState').style.display = 'block';
            hideLoadingState();
            hideErrorState();
        }

        function hideSuccessState() {
            document.getElementById('successState').style.display = 'none';
        }

        function getErrorMessage(error) {
            switch (error) {
                case 'oauth_denied':
                    return 'Google Drive authorization was denied. Your profile was saved without files.';
                case 'oauth_invalid':
                    return 'Invalid authorization response. Please try again.';
                case 'token_failed':
                    return 'Failed to get authorization token. Please try again.';
                case 'callback_failed':
                    return 'Authorization callback failed. Please try again.';
                default:
                    return 'An error occurred during authorization.';
            }
        }

        // ===========================================
        // DATA LOADING
        // ===========================================
        async function loadVendorData(token) {
            showLoadingState();
            
            try {
                console.log('📡 Fetching vendor profile...');
                const response = await fetch(`${API_BASE}/vendor-profile?token=${token}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                vendorData = await response.json();
                console.log('✅ Vendor data loaded:', vendorData);
                
                populateForm(vendorData);
                await loadOrganizationContacts(token);
                
            } catch (error) {
                console.error('💥 Failed to load vendor data:', error);
                throw error;
            }
        }

        async function loadOrganizationContacts(token) {
            console.log('👥 Loading organization contacts...');
            
            try {
                const response = await fetch(`${API_BASE}/get-organization-contacts?token=${token}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                organizationContacts = data.contacts;
                
                console.log(`✅ Loaded ${organizationContacts.length} contacts for ${data.organizationName}`);
                
            } catch (error) {
                console.error('💥 Error loading contacts:', error);
            }
        }

        function populateForm(data) {
            console.log('📝 Populating form with:', data);
            
            // Display organization logo in the logo container
            const organizationLogoContainer = document.getElementById('organizationLogo');
            if (data.organization?.logo) {
                organizationLogoContainer.innerHTML = `<img src="${data.organization.logo}" alt="${data.organization.name} Logo" class="organization-logo">`;
            } else if (data.organization?.name) {
                organizationLogoContainer.innerHTML = `<div class="organization-name">${data.organization.name}</div>`;
            }
            
            formState.institutionName = data.organization?.name || '';
            formState.website = data.organization?.website || '';
            formState.category = data.organization?.primaryCategory || '';
            formState.institutionSize = data.organization?.institutionSize || '';

            // Store address data in both formats for compatibility
            formState.streetAddress = data.organization?.address?.streetAddress || '';
            formState.city = data.organization?.address?.city || '';
            formState.province = data.organization?.address?.province || '';
            formState.postalCode = data.organization?.address?.postalCode || '';

            // Also store as address object for the new editing system
            formState.address = {
                streetAddress: formState.streetAddress,
                city: formState.city,
                province: formState.province,
                postalCode: formState.postalCode
            };

            updateFieldDisplay('institutionName', formState.institutionName);
            updateFieldDisplay('website', formState.website);
            updateFieldDisplay('category', formState.category);

            // Update address block display
            updateAddressDisplay();

            // Store initial form state for change detection
            window.initialFormState = JSON.parse(JSON.stringify(formState));
            console.log('💾 Initial form state stored for change detection');

            // Store vendor data globally for address modal access
            window.vendorData = {
                organization: data.organization,
                institutionSizeOptions: data.institutionSizeOptions,
                provinceOptions: data.provinceOptions
            };

            // Populate dropdowns and set current values
            populateInstitutionSizeDropdown(data.institutionSizeOptions, formState.institutionSize);
            populateProvinceDropdown(data.provinceOptions, formState.province);

            window.formData = {
                organization: data.organization
            };
        }

        function populateInstitutionSizeDropdown(options, currentValue) {
            console.log('🎯 Populating institution size dropdown:', { options, currentValue });

            const optionsContainer = document.getElementById('institutionSizeOptions');
            const displayText = document.getElementById('institutionSizeText');

            if (!optionsContainer || !options) {
                console.log('❌ Missing elements:', { optionsContainer, options });
                return;
            }

            // Clear existing options
            optionsContainer.innerHTML = '';

            // Populate options
            options.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'dropdown-option';
                optionElement.setAttribute('data-value', option.value);
                optionElement.textContent = option.label;
                optionsContainer.appendChild(optionElement);
                console.log('➕ Added option:', option);
            });

            // Set current value if exists
            if (currentValue) {
                console.log('🔍 Looking for current value:', currentValue);
                const currentOption = options.find(option => option.value === currentValue);
                console.log('📍 Found current option:', currentOption);

                if (currentOption) {
                    displayText.textContent = currentOption.label;
                    formState.institutionSize = currentValue;
                    console.log('✅ Set display to:', currentOption.label);
                } else {
                    console.log('❌ Current value not found in options');
                }
            } else {
                console.log('ℹ️ No current value to set');
            }
        }

        function populateProvinceDropdown(options, currentValue) {
            console.log('🍁 Populating province dropdown:', { options, currentValue });

            const optionsContainer = document.getElementById('provinceOptions');
            const displayText = document.getElementById('provinceText');

            if (!optionsContainer || !options) {
                console.log('❌ Missing province elements:', { optionsContainer, options });
                return;
            }

            // Clear existing options
            optionsContainer.innerHTML = '';

            // Populate options
            options.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'dropdown-option';
                optionElement.setAttribute('data-value', option.value);
                optionElement.textContent = option.label;
                optionsContainer.appendChild(optionElement);
            });

            // Set current value if exists
            if (currentValue) {
                console.log('🔍 Looking for current province:', currentValue);
                const currentOption = options.find(option => option.value === currentValue);
                console.log('📍 Found current province option:', currentOption);

                if (currentOption) {
                    displayText.textContent = currentOption.label;
                    formState.province = currentValue;
                    console.log('✅ Set province display to:', currentOption.label);
                } else {
                    console.log('❌ Current province value not found in options');
                }
            } else {
                console.log('ℹ️ No current province value to set');
            }
        }

        function updateAddressDisplay() {
            const addressLine1 = document.getElementById('addressLine1');
            const cityPart = document.getElementById('cityPart');
            const provincePart = document.getElementById('provincePart');
            const postalCodePart = document.getElementById('postalCodePart');

            // Get address data from either the address object or individual fields (for backward compatibility)
            const addressData = formState.address || {};
            const streetAddress = addressData.streetAddress || formState.streetAddress || 'Street address';
            const city = addressData.city || formState.city || 'City';
            const province = addressData.province || formState.province || 'Province';
            const postalCode = addressData.postalCode || formState.postalCode || 'Postal Code';

            if (addressLine1) {
                addressLine1.textContent = streetAddress;
            }

            if (cityPart) {
                cityPart.textContent = city;
            }

            if (provincePart) {
                provincePart.textContent = province;
            }

            if (postalCodePart) {
                postalCodePart.textContent = postalCode;
            }
        }

        // ===========================================
        // STEP 2 INITIALIZATION
        // ===========================================
        function initializeStep2() {
            initializeImageUpload();
            updateFieldDisplay('highlightHeadline', formState.highlightHeadline);
            updateFieldDisplay('highlightDescription', formState.highlightDescription);
            updateFieldDisplay('highlightDeal', formState.highlightDeal);
            initializeBillingDropdowns();
            console.log('🚀 Step 2 initialized with unified field system and billing dropdowns!');
        }
        
        function initializeImageUpload() {
            const container = document.getElementById('imageUploadContainer');
            const fileInput = document.getElementById('fileInput');

            if (!container || !fileInput) return;

            container.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.classList.add('dragover');
            });

            container.addEventListener('dragleave', () => {
                container.classList.remove('dragover');
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                container.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            });
        }
        
        function handleFileSelection(file) {
            if (!file.type.match(/^image\/(jpeg|jpg|png)$/i)) {
                showImageError('Please select a JPEG or PNG image file.');
                return;
            }

            const maxSize = 12 * 1024 * 1024; // 12MB
            if (file.size > maxSize) {
                showImageError('File size exceeds 12MB limit. Please choose a smaller image or reduce the quality.');
                return;
            }

            console.log('📸 Valid file selected:', file.name);
            currentFile = file;
            showCropModal(file);
        }
        
        function showImageError(message) {
            const errorElement = document.getElementById('imageError');
            if (!errorElement) return;
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => errorElement.style.display = 'none', 5000);
        }
        
        function showCropModal(file) {
            const modal = document.getElementById('cropModal');
            const cropImage = document.getElementById('cropImage');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                cropImage.src = e.target.result;
                modal.style.display = 'flex';
                
                if (cropperInstance) cropperInstance.destroy();
                
                cropperInstance = new Cropper(cropImage, {
                    aspectRatio: 9/16,
                    viewMode: 1,
                    autoCropArea: 1,
                    responsive: true,
                    background: false,
                    movable: true,
                    scalable: true,
                    rotatable: false,
                    zoomable: true
                });
            };
            reader.readAsDataURL(file);
        }
        
        function cancelCrop() {
            const modal = document.getElementById('cropModal');
            if (modal) modal.style.display = 'none';
            if (cropperInstance) {
                cropperInstance.destroy();
                cropperInstance = null;
            }
            currentFile = null;
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
        }
        
        function applyCrop() {
            if (!cropperInstance) return;
            
            const canvas = cropperInstance.getCroppedCanvas({
                width: 540,
                height: 960,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            canvas.toBlob((blob) => {
                if (blob) uploadImageToS3(blob);
            }, 'image/jpeg', 0.9);
            
            cancelCrop();
        }
        
        async function uploadImageToS3(blob) {
            console.log('📤 Starting S3 upload...');
            
            const progressContainer = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('uploadProgressFill');
            
            if (progressContainer && progressFill) {
                progressContainer.style.display = 'block';
                
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 30;
                    if (progress > 90) progress = 90;
                    progressFill.style.width = progress + '%';
                }, 200);
        
                try {
                    const organizationName = formState?.companyName || 'Demo Company';
                    const token = new URLSearchParams(window.location.search).get('token') || 'demo-token';
                    const base64 = await blobToBase64(blob);
                    
                    // Consistent naming - always overwrites the previous image
                    const uploadData = {
                        files: [{
                            name: 'highlight-image.jpg', // Always the same name
                            content: base64.split(',')[1],
                            type: 'image/jpeg',
                            fieldName: 'highlightImage'
                        }],
                        organizationName: organizationName,
                        token: token
                    };
        
                    const response = await fetch(`${API_BASE}/upload-to-s3`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(uploadData)
                    });
        
                    if (!response.ok) throw new Error(`Upload failed: ${response.status}`);
        
                    const result = await response.json();
                    
                    clearInterval(progressInterval);
                    progressFill.style.width = '100%';
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        progressFill.style.width = '0%';
                    }, 1000);
        
                    const imageUrl = result.uploadResults?.highlightImageUrl;
                    
                    if (imageUrl) {
                        showUploadedImage(imageUrl);
                        formState.highlightImageUrl = imageUrl;
                        console.log('✅ Image uploaded successfully:', imageUrl);
                    } else {
                        throw new Error('No highlight image URL found in response');
                    }
        
                } catch (error) {
                    console.error('💥 Upload failed:', error);
                    clearInterval(progressInterval);
                    progressContainer.style.display = 'none';
                    progressFill.style.width = '0%';
                    showImageError('Upload failed. Please try again.');
                }
            }
        }
        // ===========================================
        // STEP 3: CONFERENCE TEAM MANAGEMENT
        // ===========================================
        let teamState = {
            attendingContacts: new Set(),
            editedContacts: {},
            newContacts: []
        };
        
        function initializeStep3() {
            populateContactList();
            setupScrollbar();
            setupAddContactHandler();
            initializeContactModal();
            console.log('🚀 Step 3 (Conference Team) initialized!');
        }
        
        function populateContactList() {
            const teamList = document.getElementById('teamList');
            const teamListWrapper = document.querySelector('.team-list-wrapper');
            if (!teamList || !teamListWrapper || !organizationContacts) return;
            
            // Clear existing content
            teamList.innerHTML = '';
            
            // Add header outside the scrolling area (if not already there)
            let existingHeader = teamListWrapper.querySelector('.contact-headers');
            if (!existingHeader) {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'contact-headers';
                headerDiv.innerHTML = `
                    <div class="header-primary">Primary Contact?</div>
                    <div class="header-spacer"></div>
                    <div class="header-attending">Attending Conference?</div>
                    <div class="header-edit"></div>
                `;
                teamListWrapper.insertBefore(headerDiv, teamList);
            }
            
            organizationContacts.forEach((contact, index) => {
                const contactElement = createContactElement(contact, index);
                teamList.appendChild(contactElement);
            });
            
            // Force scrollbar update after content is added
            setTimeout(() => {
                if (window.updateScrollbar) {
                    window.updateScrollbar();
                }
            }, 100);
            
            console.log(`👥 Populated ${organizationContacts.length} contacts`);
        }
        
        function createContactElement(contact, index) {
            const contactDiv = document.createElement('div');
            contactDiv.className = 'contact-item';
            contactDiv.dataset.contactId = contact.id;
            contactDiv.dataset.index = index;
            
            const isAttending = teamState.attendingContacts.has(contact.id);
            
            // Format phone number for display
            const phone = contact.workPhone || '';
            const formattedPhone = phone ? formatPhoneForDisplay(phone) : '';
            
            // Get dietary restrictions from Notion contact data
            const dietaryRestrictions = contact.dietaryRestrictions || '';

            contactDiv.innerHTML = `
                <div class="primary-contact-selector" onclick="setPrimaryContact('${contact.id}'); event.stopPropagation();" title="Click to set as primary contact">
                    ${contact.isPrimaryContact ? '<span class="primary-crown">👑</span>' : '<div class="primary-placeholder"></div>'}
                </div>
                <div class="contact-info">
                    <div class="contact-name">${contact.name}</div>
                    <div class="contact-title">${contact.roleTitle || ''}</div>
                    <div class="contact-email">${contact.workEmail || ''}</div>
                    <div class="contact-phone">${formattedPhone}</div>
                    <div class="contact-dietary">${dietaryRestrictions}</div>
                </div>
                <div class="contact-checkbox" onclick="toggleAttendance('${contact.id}'); event.stopPropagation();" title="Click to mark as attending">
                    <div class="checkbox-circle ${isAttending ? 'checked' : ''}"></div>
                </div>
                <button class="contact-edit" onclick="editContact('${contact.id}', ${index}); event.stopPropagation();">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                        <path d="m14.5 5.5 4 4"/>
                    </svg>
                </button>
            `;
            
            return contactDiv;
        }
        
        function formatPhoneForDisplay(phone) {
            // Remove all non-digit characters
            const digits = phone.replace(/\D/g, '');
            
            // Format as (XXX) XXX-XXXX if 10 digits, otherwise return as-is
            if (digits.length === 10) {
                return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
            }
            return phone;
        }
        
        function toggleAttendance(contactId) {
            const checkbox = document.querySelector(`[data-contact-id="${contactId}"] .checkbox-circle`);
            if (!checkbox) return;

            if (teamState.attendingContacts.has(contactId)) {
                teamState.attendingContacts.delete(contactId);
                checkbox.classList.remove('checked');
                console.log(`👤 Marked ${contactId} as NOT attending`);
            } else {
                teamState.attendingContacts.add(contactId);
                checkbox.classList.add('checked');
                console.log(`✅ Marked ${contactId} as attending`);
            }
        }

        function setPrimaryContact(contactId) {
            // Update the contact data
            organizationContacts.forEach(contact => {
                contact.isPrimaryContact = (contact.id === contactId);
            });

            // Update the visual state - remove all crowns first
            document.querySelectorAll('.primary-contact-selector').forEach(selector => {
                selector.innerHTML = '<div class="primary-placeholder"></div>';
            });

            // Add crown to the selected contact
            const selectedSelector = document.querySelector(`[data-contact-id="${contactId}"] .primary-contact-selector`);
            if (selectedSelector) {
                selectedSelector.innerHTML = '<span class="primary-crown">👑</span>';
            }

            console.log(`👑 Set ${contactId} as primary contact`);
        }
   
        function setupScrollbar() {
            const teamList = document.getElementById('teamList');
            const scrollbar = document.getElementById('teamScrollbar');
            const scrollbarThumb = document.getElementById('scrollbarThumb');
            
            if (!teamList || !scrollbar || !scrollbarThumb) return;
            
            function updateScrollbarVisibility() {
                const scrollHeight = teamList.scrollHeight;
                const clientHeight = teamList.clientHeight;
                
                if (scrollHeight <= clientHeight) {
                    scrollbar.style.display = 'none';
                    return false;
                } else {
                    scrollbar.style.display = 'block';
                    return true;
                }
            }
            
            function updateScrollbar() {
                const scrollHeight = teamList.scrollHeight;
                const clientHeight = teamList.clientHeight;
                
                if (!updateScrollbarVisibility()) {
                    return;
                }
                
                // Calculate thumb height as proportion of visible area
                const thumbHeight = (clientHeight / scrollHeight) * clientHeight;
                scrollbarThumb.style.height = thumbHeight + 'px';
                
                // Calculate thumb position
                const scrollTop = teamList.scrollTop;
                const maxScroll = scrollHeight - clientHeight;
                const thumbMaxTop = clientHeight - thumbHeight;
                const thumbTop = maxScroll > 0 ? (scrollTop / maxScroll) * thumbMaxTop : 0;
                
                scrollbarThumb.style.top = thumbTop + 'px';
            }
            
            // Update scrollbar on scroll
            teamList.addEventListener('scroll', updateScrollbar);
            
            // Handle scrollbar thumb dragging
            let isDragging = false;
            let startY = 0;
            let startScrollTop = 0;
            
            scrollbarThumb.addEventListener('mousedown', (e) => {
                isDragging = true;
                startY = e.clientY;
                startScrollTop = teamList.scrollTop;
                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('mouseup', handleDragEnd);
                e.preventDefault();
            });
            
            function handleDrag(e) {
                if (!isDragging) return;
                
                const deltaY = e.clientY - startY;
                const scrollHeight = teamList.scrollHeight;
                const clientHeight = teamList.clientHeight;
                const maxScroll = scrollHeight - clientHeight;
                const thumbHeight = parseFloat(scrollbarThumb.style.height);
                const thumbMaxTop = clientHeight - thumbHeight;
                
                if (thumbMaxTop > 0) {
                    const scrollDelta = (deltaY / thumbMaxTop) * maxScroll;
                    teamList.scrollTop = startScrollTop + scrollDelta;
                }
            }
            
            function handleDragEnd() {
                isDragging = false;
                document.removeEventListener('mousemove', handleDrag);
                document.removeEventListener('mouseup', handleDragEnd);
            }
            
            // Initial update
            setTimeout(updateScrollbar, 100);
            
            // Store reference for external calls
            window.updateScrollbar = updateScrollbar;
        }
        
        function setupAddContactHandler() {
            const addContactSection = document.querySelector('.add-contact-section');
            if (addContactSection) {
                addContactSection.addEventListener('click', () => {
                    console.log('➕ Add new contact clicked');
                    // TODO: Open new contact modal
                });
            }
        }
        
        function editContact(contactId, index) {
            console.log(`✏️ Edit contact clicked: ${contactId} (index: ${index})`);
            openEditContactModal(contactId, index);
            // event.stopPropagation() is called inline in the HTML
        }    
        function initializeContactModal() {
            setupModalFieldHandlers();
            console.log('📝 Contact modal initialized');
        }
        function initializeStep6() {
            console.log('🚀 Step 6 (Results) initialized!');
        }
        // ===========================================
        // CONTACT MODAL MANAGEMENT
        // ===========================================
        let modalState = {
            isOpen: false,
            mode: 'edit', // 'edit' or 'new'
            currentContact: null,
            currentContactIndex: null,
            formData: {}
        };

        function updateModalLabels(prefix) {
            const labels = {
                name: 'Name',
                title: 'Job title',
                email: 'Email',
                phone: 'Phone'
            };
            
            Object.keys(labels).forEach(fieldName => {
                const label = document.getElementById(`${fieldName}Label`);
                if (label) {
                    if (prefix === 'Current' && fieldName !== 'name') {
                        // For edit mode, show current values in labels
                        const currentValue = modalState.currentContact[fieldName === 'title' ? 'roleTitle' : fieldName === 'email' ? 'workEmail' : fieldName === 'phone' ? 'workPhone' : fieldName];
                        label.textContent = currentValue ? `Current: ${currentValue}` : `Current: ${labels[fieldName]}`;
                    } else {
                        label.textContent = `${prefix}: ${labels[fieldName]}`;
                    }
                }
            });
        }
        
        function setupModalFieldHandlers() {
            const fields = ['name', 'title', 'email', 'phone', 'dietary'];
            
            fields.forEach(fieldName => {
                const input = document.getElementById(`${fieldName}Input`);
                const border = document.getElementById(`${fieldName}Border`);
                const label = document.getElementById(`${fieldName}Label`);
                
                if (input && border && label) {
                    input.addEventListener('focus', () => {
                        border.classList.remove('unfocused');
                        border.classList.add('focused');
                        label.classList.remove('unfocused');
                        label.classList.add('focused');
                    });
                    
                    input.addEventListener('blur', () => {
                        border.classList.remove('focused');
                        border.classList.add('unfocused');
                        label.classList.remove('focused');
                        label.classList.add('unfocused');
                    });
                    
                    // Store form data as user types
                    input.addEventListener('input', () => {
                        modalState.formData[fieldName] = input.value;
                    });
                }
            });
        }
        
        function openEditContactModal(contactId, contactIndex) {
            // Find the contact data
            let contact = organizationContacts.find(c => c.id === contactId);
            
            // If not found in original contacts, check new contacts
            if (!contact) {
                contact = teamState.newContacts.find(c => c.id === contactId);
            }
            
            if (!contact) {
                console.error('❌ Contact not found:', contactId);
                return;
            }
            
            modalState.mode = 'edit';
            modalState.currentContact = contact;
            modalState.currentContactIndex = contactIndex;
            modalState.formData = {
                name: contact.name || '',
                title: contact.roleTitle || '',
                email: contact.workEmail || '',
                phone: contact.workPhone || '',
                dietary: contact.dietaryRestrictions || ''
            };
            
            // Update modal content
            document.getElementById('modalTitle').textContent = 'Current: ' + contact.name;
            updateModalLabels('Current');
            populateModalForm();

            // Show delete button for edit mode
            document.getElementById('deleteContactBtn').style.display = 'block';

            showContactModal();
            
            console.log('✏️ Opened edit modal for:', contact.name);
        }
        
        function openNewContactModal() {
            modalState.mode = 'new';
            modalState.currentContact = null;
            modalState.currentContactIndex = null;
            modalState.formData = {
                name: '',
                title: '',
                email: '',
                phone: '',
                dietary: ''
            };
            
            // Update modal content
            document.getElementById('modalTitle').textContent = 'New contact: Name';
            updateModalLabels('New contact');
            populateModalForm();

            // Hide delete button for new mode
            document.getElementById('deleteContactBtn').style.display = 'none';

            showContactModal();
            
            console.log('➕ Opened new contact modal');
        }
        
       function updateModalLabels(prefix) {
            const labels = {
                name: 'Name',
                title: 'Job title',
                email: 'Email',
                phone: 'Phone'
            };
            
            Object.keys(labels).forEach(fieldName => {
                const label = document.getElementById(`${fieldName}Label`);
                if (label) {
                    if (prefix === 'Current' && fieldName !== 'name') {
                        // For edit mode, show current values in labels
                        const currentValue = modalState.currentContact[fieldName === 'title' ? 'roleTitle' : fieldName === 'email' ? 'workEmail' : fieldName === 'phone' ? 'workPhone' : fieldName];
                        label.textContent = currentValue ? `Current: ${currentValue}` : `Current: ${labels[fieldName]}`;
                    } else {
                        label.textContent = `${prefix}: ${labels[fieldName]}`;
                    }
                }
            });
        }
        
        function populateModalForm() {
            const fields = ['name', 'title', 'email', 'phone', 'dietary'];

            fields.forEach(fieldName => {
                const input = document.getElementById(`${fieldName}Input`);
                if (input) {
                    input.value = modalState.formData[fieldName] || '';
                }
            });
        }
        
        function showContactModal() {
            const modal = document.getElementById('contactModal');
            const body = document.body;
            
            modal.classList.add('active');
            body.classList.add('modal-open');
            modalState.isOpen = true;
            
            // Focus first input
            setTimeout(() => {
                const firstInput = document.getElementById('nameInput');
                if (firstInput) firstInput.focus();
            }, 100);
        }
        
        function hideContactModal() {
            const modal = document.getElementById('contactModal');
            const body = document.body;
            
            if (modal) modal.classList.remove('active');
            body.classList.remove('modal-open');
            modalState.isOpen = false;
            
            // Clear form data
            modalState.formData = {};
        }
        
        function cancelContactModal() {
            hideContactModal();
            console.log('❌ Contact modal cancelled');
        }
        
        function saveContactModal() {
            // Validate required fields
            if (!modalState.formData.name || modalState.formData.name.trim() === '') {
                alert('Please enter a name');
                document.getElementById('nameInput').focus();
                return;
            }
            
            if (modalState.mode === 'edit') {
                saveEditedContact();
            } else {
                saveNewContact();
            }
            
            hideContactModal();
        }
        
        function saveEditedContact() {
            const contactId = modalState.currentContact.id;
            const updatedData = { ...modalState.formData };
            
            // Store the edit in teamState
            teamState.editedContacts[contactId] = updatedData;
            
            // Update the contact display
            updateContactDisplay(contactId, updatedData);
            
            console.log('✅ Contact edited:', contactId, updatedData);
        }
        
        function saveNewContact() {
            const newContact = {
                id: 'new_' + Date.now(), // Temporary ID
                name: modalState.formData.name,
                roleTitle: modalState.formData.title,
                workEmail: modalState.formData.email,
                workPhone: modalState.formData.phone,
                dietaryRestrictions: modalState.formData.dietary,
                isNew: true
            };
            
            // Add to teamState
            teamState.newContacts.push(newContact);
            
            // Add to the contact list display
            addNewContactToList(newContact);
            
            console.log('✅ New contact created:', newContact);
        }
        
        function updateContactDisplay(contactId, updatedData) {
            const contactElement = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (!contactElement) return;

            // Update the display with new data
            const nameElement = contactElement.querySelector('.contact-name');
            const titleElement = contactElement.querySelector('.contact-title');
            const emailElement = contactElement.querySelector('.contact-email');
            const phoneElement = contactElement.querySelector('.contact-phone');
            const dietaryElement = contactElement.querySelector('.contact-dietary');

            if (nameElement) nameElement.textContent = updatedData.name;
            if (titleElement) titleElement.textContent = updatedData.title;
            if (emailElement) emailElement.textContent = updatedData.email;
            if (phoneElement) phoneElement.textContent = formatPhoneForDisplay(updatedData.phone);
            if (dietaryElement) dietaryElement.textContent = updatedData.dietary || '';
        }
        
        function addNewContactToList(newContact) {
            const teamList = document.getElementById('teamList');
            if (!teamList) return;
            
            const contactElement = createContactElement(newContact, -1);
            teamList.appendChild(contactElement);
            
            // Update scrollbar
            setTimeout(() => {
                if (window.updateScrollbar) {
                    window.updateScrollbar();
                }
            }, 100);
        }
        
        // Update the existing edit and add contact functions
        function editContact(contactId, index) {
            openEditContactModal(contactId, index);
        }
        
        function setupAddContactHandler() {
            const addContactSection = document.querySelector('.add-contact-section');
            if (addContactSection) {
                addContactSection.addEventListener('click', () => {
                    openNewContactModal();
                });
            }
        }

        function confirmDeleteContact() {
            if (!modalState.currentContact) return;

            const contactName = modalState.currentContact.name;
            const confirmMessage = `Are you sure you want to delete ${contactName}?`;

            if (confirm(confirmMessage)) {
                deleteContact();
            }
        }

        function deleteContact() {
            const contactId = modalState.currentContact.id;
            const contactName = modalState.currentContact.name;

            // Flag for deletion in teamState
            if (!teamState.deletedContacts) {
                teamState.deletedContacts = new Set();
            }
            teamState.deletedContacts.add(contactId);

            // Remove from UI
            const contactElement = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (contactElement) {
                contactElement.remove();
            }

            // Remove from organizationContacts array
            const contactIndex = organizationContacts.findIndex(c => c.id === contactId);
            if (contactIndex !== -1) {
                organizationContacts.splice(contactIndex, 1);
            }

            // Remove from teamState if they were new or edited
            if (teamState.newContacts) {
                teamState.newContacts = teamState.newContacts.filter(c => c.id !== contactId);
            }
            if (teamState.editedContacts && teamState.editedContacts[contactId]) {
                delete teamState.editedContacts[contactId];
            }

            // Remove from attending list
            teamState.attendingContacts.delete(contactId);

            // If this was the primary contact, clear primary selection
            if (modalState.currentContact.isPrimaryContact) {
                organizationContacts.forEach(contact => {
                    contact.isPrimaryContact = false;
                });
            }

            console.log(`🗑️ Deleted contact: ${contactName}`);
            hideContactModal();

            // Update scrollbar
            setTimeout(() => {
                if (window.updateScrollbar) {
                    window.updateScrollbar();
                }
            }, 100);
        }
        // ===========================================
        // STEP 4: PRIMARY CONTACT SELECTION - COMPLETE SECTION
        // ===========================================
        
        let primaryContactState = {
            selectedContactId: null
        };
        
        function initializeStep4() {
            // First populate the list
            populatePrimaryContactList();
            
            // Then auto-select primary contact if one exists
            const primaryContact = organizationContacts.find(contact => contact.isPrimaryContact);
            if (primaryContact) {
                primaryContactState.selectedContactId = primaryContact.id;
                console.log(`🎯 Auto-selected primary contact: ${primaryContact.name}`);
                
                // Re-populate to show the selection
                setTimeout(() => {
                    populatePrimaryContactList();
                }, 50);
            }
            
            console.log('🚀 Step 4 (Primary Contact) initialized!');
        }
        
        function populatePrimaryContactList() {
            const primaryContactList = document.getElementById('primaryContactList');
            if (!primaryContactList || !organizationContacts) return;
            
            primaryContactList.innerHTML = '';
        
            // COMBINE original contacts + newly created contacts from Step 3
            const allAvailableContacts = [
                ...organizationContacts, // Original contacts from API
                ...teamState.newContacts.map(newContact => ({
                    id: newContact.id,
                    name: newContact.name,
                    workEmail: newContact.workEmail,
                    workPhone: newContact.workPhone,
                    roleTitle: newContact.roleTitle,
                    isPrimaryContact: false,
                    isNew: true
                }))
            ];
            
            allAvailableContacts.forEach((contact, index) => {
                const contactElement = createPrimaryContactElement(contact, index);
                primaryContactList.appendChild(contactElement);
            });
            
            // Count primary contacts for debugging
            const primaryContactsCount = allAvailableContacts.filter(c => c.isPrimaryContact).length;
            console.log(`👑 Found ${primaryContactsCount} primary contacts`);
            
            console.log(`✅ Returning ${allAvailableContacts.length} contacts for primary selection (${organizationContacts.length} original + ${teamState.newContacts.length} new)`);
        }
        
        function createPrimaryContactElement(contact, index) {
            const contactDiv = document.createElement('div');
            contactDiv.className = 'primary-contact-item';
            contactDiv.dataset.contactId = contact.id;
            contactDiv.dataset.index = index;
            
            const isSelected = primaryContactState.selectedContactId === contact.id;
            if (isSelected) {
                contactDiv.classList.add('selected');
            }
            
            // Get the contact data (check for edits from Step 3)
            const contactData = teamState.editedContacts[contact.id] || contact;
            
            // Format phone number for display
            const phone = contactData.workPhone || contact.workPhone || '';
            const formattedPhone = phone ? formatPhoneForDisplay(phone) : '';
            
            // Add visual indicators for existing primary contacts and new contacts
            const primaryIndicator = contact.isPrimaryContact ? ' 👑' : '';
            const newIndicator = contact.isNew ? ' (New)' : '';
            
            contactDiv.innerHTML = `
                <div class="primary-contact-radio" onclick="selectPrimaryContact('${contact.id}')">
                    <div class="radio-circle ${isSelected ? 'selected' : ''}"></div>
                </div>
                <div class="primary-contact-info">
                    <div class="primary-contact-name">${contactData.name || contact.name}${primaryIndicator}${newIndicator}</div>
                    <div class="primary-contact-title">${contactData.title || contactData.roleTitle || contact.roleTitle || ''}</div>
                    <div class="primary-contact-email">${contactData.email || contactData.workEmail || contact.workEmail || ''}</div>
                    <div class="primary-contact-phone">${formattedPhone}</div>
                </div>
            `;
            
            // Make the whole item clickable
            contactDiv.addEventListener('click', () => selectPrimaryContact(contact.id));
            
            return contactDiv;
        }
        
        function selectPrimaryContact(contactId) {
            // Update the state
            primaryContactState.selectedContactId = contactId;
            
            // Find contact name for logging
            const allContacts = [...organizationContacts, ...teamState.newContacts];
            const contact = allContacts.find(c => c.id === contactId);
            const contactData = teamState.editedContacts[contactId] || contact;
            const contactName = contactData?.name || contact?.name || 'Unknown';
            
            console.log(`👑 Selected primary contact: ${contactName} (${contactId})`);
            
            // Refresh the entire list to show the updated selection
            populatePrimaryContactList();
        }
        // ===========================================
        // STEP 5: PRODUCT CATALOGUE UPLOAD
        // ===========================================
        let catalogueState = {
            uploadedFile: null,
            uploadedUrl: null
        };
        
        function initializeStep5() {
            initializeCatalogueUpload();
            console.log('🚀 Step 5 (Product Catalogue) initialized!');
        }
        
        function initializeCatalogueUpload() {
            const container = document.getElementById('catalogueUploadContainer');
            const fileInput = document.getElementById('catalogueFileInput');
        
            if (!container || !fileInput) return;
        
            // Click to select file
            container.addEventListener('click', () => fileInput.click());
        
            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleCatalogueFileSelection(e.target.files[0]);
                }
            });
        
            // Drag and drop
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.classList.add('dragover');
            });
        
            container.addEventListener('dragleave', () => {
                container.classList.remove('dragover');
            });
        
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                container.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleCatalogueFileSelection(e.dataTransfer.files[0]);
                }
            });
        }
        
        function handleCatalogueFileSelection(file) {
            console.log('📄 File selected:', file.name, file.type, file.size);
            
            // Validate file type (only PDFs)
            if (file.type !== 'application/pdf') {
                showCatalogueError('Please select a PDF file only.');
                return;
            }
        
            // Validate file size (25MB max)
            const maxSize = 25 * 1024 * 1024; // 25MB
            if (file.size > maxSize) {
                showCatalogueError('File size exceeds 25MB limit. Please choose a smaller PDF file.');
                return;
            }
        
            console.log('✅ Valid PDF file selected:', file.name);
            catalogueState.uploadedFile = file;
            uploadCatalogueToS3(file);
        }
        
        async function uploadCatalogueToS3(file) {
            console.log('📤 Starting catalogue upload to S3...');
            
            const progressContainer = document.getElementById('catalogueUploadProgress');
            const progressFill = document.getElementById('catalogueUploadProgressFill');
            const container = document.getElementById('catalogueUploadContainer');
            const placeholder = document.getElementById('cataloguePlaceholder');
            const successSection = document.getElementById('catalogueSuccess');
            
            // Show progress
            progressContainer.style.display = 'block';
            
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 90) progress = 90;
                progressFill.style.width = progress + '%';
            }, 300);
        
            try {
                const organizationName = formState?.companyName || 'Demo Company';
                const token = new URLSearchParams(window.location.search).get('token') || 'demo-token';
                const base64 = await fileToBase64(file);
                
                // Consistent naming - always overwrites the previous catalogue
                const uploadData = {
                    files: [{
                        name: 'catalogue.pdf', // Always the same name
                        content: base64.split(',')[1],
                        type: file.type,
                        fieldName: 'catalogFile'
                    }],
                    organizationName: organizationName,
                    token: token
                };
        
                const response = await fetch(`${API_BASE}/upload-to-s3`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(uploadData)
                });
        
                if (!response.ok) throw new Error(`Upload failed: ${response.status}`);
        
                const result = await response.json();
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressFill.style.width = '0%';
                    
                    // Show success state
                    placeholder.style.display = 'none';
                    successSection.style.display = 'flex';
                    container.classList.add('uploaded');
                    
                    // Update success text with original filename for user feedback
                    document.getElementById('successFilename').textContent = file.name;
                    
                }, 1000);
        
                // Store the uploaded file URL
                const catalogueUrl = result.uploadResults?.catalogueUrl;
                if (catalogueUrl) {
                    catalogueState.uploadedUrl = catalogueUrl;
                    console.log('✅ Catalogue uploaded successfully:', catalogueUrl);
                } else {
                    throw new Error('No catalogue URL found in response');
                }
        
            } catch (error) {
                console.error('💥 Catalogue upload failed:', error);
                clearInterval(progressInterval);
                progressContainer.style.display = 'none';
                progressFill.style.width = '0%';
                showCatalogueError('Upload failed. Please try again.');
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        function showCatalogueError(message) {
            const errorElement = document.getElementById('catalogueError');
            if (!errorElement) return;
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => errorElement.style.display = 'none', 5000);
        }

        function showUploadedImage(imageUrl) {
            const placeholder = document.getElementById('imagePlaceholder');
            const uploadedImage = document.getElementById('uploadedImage');
            const container = document.getElementById('imageUploadContainer');
            
            if (placeholder && uploadedImage && container) {
                placeholder.style.display = 'none';
                uploadedImage.src = imageUrl;
                uploadedImage.style.display = 'block';
                
                // Update overlay text for uploaded state
                const overlay = document.getElementById('imageOverlay');
                if (overlay) {
                    overlay.textContent = 'Click to change image';
                }
                
                console.log('📸 Image displayed successfully');
            }
        }

        function validateFinalSubmission() {
            const errors = [];
            
            // Validate required fields
            if (!formState.companyName) {
                errors.push('Company name is required');
            }
            
            if (!formState.category) {
                errors.push('Primary category is required');
            }
            
            // Validate at least one attending contact
            if (teamState.attendingContacts.size === 0) {
                errors.push('At least one team member must be attending the conference');
            }
            
            // Validate primary contact is selected
            if (!primaryContactState.selectedContactId) {
                errors.push('A primary contact must be selected');
            }
            
            if (errors.length > 0) {
                alert('Please fix the following issues:\n\n' + errors.join('\n'));
                return false;
            }
            
            return true;
        }
        
        async function finishWizard() {
           console.log('🎉 Wizard complete! Validating submission...');
           
           // Step 1: Validate
           if (!validateFinalSubmission()) {
               return;
           }
           
           // Step 2: Initialize step 6 and mark everything complete
           showStep(6);
           document.querySelectorAll('.step-item').forEach(item => {
               item.classList.remove('active');
               item.classList.add('completed');
           });
           
           // Step 3: Show uploading screen
           showUploadingState();
           
           // Step 4: Try all the upload APIs
           let hasErrors = false;
           const token = new URLSearchParams(window.location.search).get('token');
           
           try {
               // Process conference team
               console.log('👥 Processing conference team...');
               
               const contactOperations = {
                   create: teamState.newContacts || [],
                   update: Object.keys(teamState.editedContacts || {}).map(contactId => ({
                       originalId: contactId,
                       name: teamState.editedContacts[contactId].name,
                       workEmail: teamState.editedContacts[contactId].email,
                       workPhone: teamState.editedContacts[contactId].phone,
                       roleTitle: teamState.editedContacts[contactId].title
                   })),
                   delete: [],
                   conferenceTeam: Array.from(teamState.attendingContacts).map(contactId => ({
                       id: contactId,
                       attending: true,
                       isPrimary: contactId === primaryContactState.selectedContactId
                   }))
                };
                
                // ADD THIS DEBUG LOGGING:
                console.log('🔍 DEBUG - teamState.attendingContacts:', teamState.attendingContacts);
                console.log('🔍 DEBUG - primaryContactState.selectedContactId:', primaryContactState.selectedContactId);
                console.log('🔍 DEBUG - contactOperations.conferenceTeam:', contactOperations.conferenceTeam);
               
               const teamResponse = await fetch(`${API_BASE}/save-conference-team`, {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify({
                       token: token,
                       contactOperations: contactOperations
                   })
               });
               
               if (!teamResponse.ok) {
                   const teamError = await teamResponse.json();
                   throw new Error(`Team processing failed: ${teamError.details || teamError.error}`);
               }
               
               console.log('✅ Conference team processed');
               
               // Submit vendor data
               console.log('📝 Submitting vendor data for review...');
               
               const vendorData = {
                   token: token,
                   formState: formState,
                   catalogueState: catalogueState
               };
               
               const vendorResponse = await fetch(`${API_BASE}/submit-vendor-profile`, {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify(vendorData)
               });
               
               if (!vendorResponse.ok) {
                   const vendorError = await vendorResponse.json();
                   throw new Error(`Vendor submission failed: ${vendorError.details || vendorError.error}`);
               }
               
               console.log('✅ Vendor data submitted');
               
           } catch (error) {
               console.error('💥 API Error:', error);
               hasErrors = true;
           }
           
           // Step 5: Hide uploading and show results
           hideUploadingState();
           
           // Step 6: Show success or failure
           if (hasErrors) {
               console.log('❌ Showing failure screen');
               document.getElementById('errorContent').style.display = 'block';
               document.getElementById('successContent').style.display = 'none';
           } else {
               console.log('✅ Showing success screen');
               document.getElementById('successContent').style.display = 'block';
               document.getElementById('errorContent').style.display = 'none';
           }
        }
        
        // State management functions
        function showUploadingState() {
            document.getElementById('uploadingState').classList.add('active');
            document.getElementById('wizardContent').style.display = 'none';
        }
        
        function hideUploadingState() {
            document.getElementById('uploadingState').classList.remove('active');
            document.getElementById('wizardContent').style.display = 'flex';
        }
    </script>

    <!-- Contact Modal (moved outside step sections) -->
    <div class="contact-modal" id="contactModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Edit Contact</h3>
            </div>
            <form class="modal-form" id="modalForm">
                <div class="modal-field">
                    <div class="modal-field-border unfocused" id="nameBorder">
                        <div class="modal-field-label unfocused" id="nameLabel">Name</div>
                        <input type="text" class="modal-field-input" id="nameInput" placeholder="Enter full name">
                    </div>
                </div>

                <div class="modal-field">
                    <div class="modal-field-border unfocused" id="titleBorder">
                        <div class="modal-field-label unfocused" id="titleLabel">Job title</div>
                        <input type="text" class="modal-field-input" id="titleInput" placeholder="Enter job title">
                    </div>
                </div>

                <div class="modal-field">
                    <div class="modal-field-border unfocused" id="emailBorder">
                        <div class="modal-field-label unfocused" id="emailLabel">Email</div>
                        <input type="email" class="modal-field-input" id="emailInput" placeholder="Enter email address">
                    </div>
                </div>

                <div class="modal-field">
                    <div class="modal-field-border unfocused" id="phoneBorder">
                        <div class="modal-field-label unfocused" id="phoneLabel">Phone</div>
                        <input type="tel" class="modal-field-input" id="phoneInput" placeholder="Enter phone number">
                    </div>
                </div>

                <div class="modal-field">
                    <div class="modal-field-border unfocused" id="dietaryBorder">
                        <div class="modal-field-label unfocused" id="dietaryLabel">Dietary restrictions</div>
                        <textarea class="modal-field-input" id="dietaryInput" placeholder="Enter dietary restrictions" rows="2"></textarea>
                    </div>
                </div>
            </form>

            <div class="modal-actions">
                <button type="button" class="modal-btn delete" id="deleteContactBtn" onclick="confirmDeleteContact()" style="display: none;">DELETE</button>
                <div class="modal-actions-right">
                    <button type="button" class="modal-btn secondary" onclick="cancelContactModal()">Cancel</button>
                    <button type="button" class="modal-btn primary" onclick="saveContactModal()">Save</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
