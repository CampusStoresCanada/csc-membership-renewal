<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Booth Profile - CSC Conference</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .booth-info {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
        }

        .booth-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-right: 15px;
        }

        .status-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-container {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            background: #fafbfc;
        }

        .section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .help-text {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 8px;
        }

        input[type="text"], 
        input[type="url"], 
        input[type="email"],
        select, 
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .file-upload {
            border: 2px dashed #c3cfe2;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #fafbfc;
            transition: all 0.2s;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .file-upload input {
            display: none;
        }

        .file-upload-text {
            color: #6c757d;
            margin-top: 10px;
        }

        .current-data {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .current-data strong {
            color: #1976d2;
        }

        .contact-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr 2fr 1fr;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .add-contact-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .remove-contact-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .submit-section {
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            border-top: 1px solid #e9ecef;
        }

        .submit-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .contact-row {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Complete Your Booth Profile</h1>
            <p>Campus Stores Canada Conference 2026</p>
        </div>

        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>Loading your profile information...</p>
        </div>

        <div id="errorState" class="error" style="display: none;">
            <strong>Oops!</strong> <span id="errorMessage"></span>
        </div>

        <div id="successState" class="success" style="display: none;">
            <h3>✅ Profile Updated Successfully!</h3>
            <p>Thank you for completing your booth profile. Your information is now under review and will appear on the conference map once approved.</p>
        </div>

        <div id="profileForm" style="display: block;">
            <div class="booth-info">
                <span class="booth-badge" id="boothNumber">Booth 501</span>
                <span class="status-badge">Profile Incomplete</span>
                <p style="margin-top: 10px; color: #6c757d;">
                    Complete your profile to help conference attendees learn about your company and products.
                </p>
            </div>

            <form id="vendorForm" class="form-container">
                <!-- Company Information Section -->
                <div class="section">
                    <h3>📋 Company Information</h3>
                    
                    <div class="form-group">
                        <label>Company Name</label>
                        <div class="current-data" id="currentCompanyName">
                            <strong>Current:</strong> <span id="companyNameValue">Loading...</span>
                        </div>
                        <div class="help-text">This will be displayed on the booth map. Leave blank to keep current name.</div>
                        <input type="text" id="companyName" name="companyName" value="" placeholder="Update company name (optional)">
                    </div>

                    <div class="form-group">
                        <label for="primaryCategory">Primary Product Category *</label>
                        <div class="help-text">Select the category that best describes your main products/services</div>
                        <select id="primaryCategory" name="primaryCategory" required>
                            <option value="">Select a category...</option>
                            <option value="Accessories">Accessories</option>
                            <option value="Apparel">Apparel</option>
                            <option value="Books">Books</option>
                            <option value="Campus Living">Campus Living</option>
                            <option value="Food & Beverages">Food & Beverages</option>
                            <option value="Gifts & Promotional Products">Gifts & Promotional Products</option>
                            <option value="Graduation & Regalia">Graduation & Regalia</option>
                            <option value="Health & Beauty">Health & Beauty</option>
                            <option value="School, Office & Lab Supplies">School, Office & Lab Supplies</option>
                            <option value="Store Operations">Store Operations</option>
                            <option value="Technology & Electronics">Technology & Electronics</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="websiteUrl">Website URL</label>
                        <div class="current-data" id="currentWebsite">
                            <strong>Current:</strong> <span id="websiteValue">No website on file</span>
                        </div>
                        <div class="help-text">This link will be displayed on your booth profile</div>
                        <input type="url" id="websiteUrl" name="websiteUrl" placeholder="https://yourcompany.com">
                    </div>

                    <div class="form-group">
                        <label for="companyDescription">Company Description</label>
                        <div class="help-text">Brief description of your company (2-3 sentences, 200 characters max)</div>
                        <textarea id="companyDescription" name="companyDescription" maxlength="200" placeholder="What does your company do? What makes you unique?"></textarea>
                    </div>
                </div>

                <!-- Conference Special Section -->
                <div class="section">
                    <h3>🌟 Conference Highlight</h3>
                    
                    <div class="two-column">
                        <div class="form-group">
                            <label for="highlightProductName">Featured Product/Service Name</label>
                            <div class="help-text">What's your "must-see" item for this conference?</div>
                            <input type="text" id="highlightProductName" name="highlightProductName" placeholder="What's hot? What's New? give it a title!">
                        </div>
                        
                        <div class="form-group">
                            <label for="highlightProductDescription">Description</label>
                            <div class="help-text">Brief description of your highlight</div>
                            <textarea id="highlightProductDescription" name="highlightProductDescription" placeholder="Now tell our members something about it that will make them want to come to your booth. If you don't know for now, leave it blank. We'll be checking in on this one closer to the conference."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Resources Section -->
                <div class="section">
                    <h3>📁 Marketing Materials</h3>
                    
                    <div class="form-group">
                        <label>Product Catalog</label>
                        <div class="help-text">Upload your main product catalog (PDF preferred, max 10MB)</div>
                        <div class="file-upload" onclick="document.getElementById('catalogFile').click()">
                            <div style="font-size: 2rem;">📄</div>
                            <div class="file-upload-text">Click to upload product catalog</div>
                            <input type="file" id="catalogFile" name="catalogFile" accept=".pdf,.doc,.docx" onchange="handleFileSelect(this, 'catalogFileName')">
                        </div>
                        <div id="catalogFileName" style="margin-top: 10px; color: #28a745;"></div>
                    </div>

                    <div class="form-group">
                        <label>Additional Resources</label>
                        <div class="help-text">Price lists, spec sheets, case studies, etc. (max 5 files, 10MB each)</div>
                        <div class="file-upload" onclick="document.getElementById('additionalFiles').click()">
                            <div style="font-size: 2rem;">📎</div>
                            <div class="file-upload-text">Click to upload additional files</div>
                            <input type="file" id="additionalFiles" name="additionalFiles" multiple accept=".pdf,.doc,.docx,.jpg,.png" onchange="handleMultipleFiles(this, 'additionalFileNames')">
                        </div>
                        <div id="additionalFileNames" style="margin-top: 10px;"></div>
                    </div>
                </div>

                <div class="submit-section">
                    <button type="submit" class="submit-btn">Update Booth Profile</button>
                    <p style="margin-top: 15px; color: #6c757d;">
                        Your submission will be reviewed and approved before appearing on the conference map.
                    </p>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = '/api'; // Will point to your Vercel functions
        let vendorData = {};
        let contactCounter = 0;
    
        // SINGLE DOMContentLoaded handler that does everything in the right order
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            
            // FIRST: Check for OAuth callback success/error
            if (urlParams.get('success') === 'true') {
                console.log('🎉 OAuth callback success!');
                document.getElementById('profileForm').style.display = 'none';
                document.getElementById('successState').style.display = 'block';
                return; // Stop here, don't load form
            }
            
            if (urlParams.get('error')) {
                const error = urlParams.get('error');
                console.error('❌ OAuth callback error:', error);
                
                let errorMessage = 'An error occurred during authorization.';
                switch (error) {
                    case 'oauth_denied':
                        errorMessage = 'Google Drive authorization was denied. Your profile was saved without files.';
                        break;
                    case 'oauth_invalid':
                        errorMessage = 'Invalid authorization response. Please try again.';
                        break;
                    case 'token_failed':
                        errorMessage = 'Failed to get authorization token. Please try again.';
                        break;
                    case 'callback_failed':
                        errorMessage = 'Authorization callback failed. Please try again.';
                        break;
                }
                
                showError(errorMessage);
                return; // Stop here, don't load form
            }
            
            // SECOND: Normal page load - get token and load vendor data
            const token = urlParams.get('token');
            if (!token) {
                showError('Invalid access link. Please check your email for the correct URL.');
                return;
            }
    
            try {
                console.log('🪄 Loading vendor data for token:', token);
                await loadVendorData(token);
            } catch (error) {
                console.error('Error loading vendor data:', error);
                showError('Unable to load your profile information. Please try again later.');
            }
        });
    
        async function loadVendorData(token) {
            showLoading(true);
            
            try {
                console.log('📡 Fetching vendor profile...');
                const response = await fetch(`${API_BASE}/vendor-profile?token=${token}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                vendorData = await response.json();
                console.log('✅ Vendor data loaded:', vendorData);
                
                populateForm(vendorData);
                showLoading(false);
                document.getElementById('profileForm').style.display = 'block';
                
            } catch (error) {
                showLoading(false);
                console.error('💥 Failed to load vendor data:', error);
                throw error;
            }
        }
    
        function populateForm(data) {
            console.log('📝 Populating form with:', data);
            
            // Update booth info
            document.getElementById('boothNumber').textContent = `Booth ${data.boothNumber}`;
        
            // Populate current company data
            document.getElementById('companyNameValue').textContent = data.organization?.name || 'No company name on file';
            document.getElementById('companyName').value = data.organization?.name || '';
            document.getElementById('websiteValue').textContent = data.organization?.website || 'No website on file';
            document.getElementById('websiteUrl').value = data.organization?.website || '';
            
            // Pre-select category if exists
            if (data.organization?.primaryCategory) {
                document.getElementById('primaryCategory').value = data.organization.primaryCategory;
            }
            
            // Populate description if exists
            if (data.organization?.description) {
                document.getElementById('companyDescription').value = data.organization.description;
            }
            
            // Populate highlight product if exists
            if (data.organization?.highlightProduct) {
                document.getElementById('highlightProductName').value = data.organization.highlightProduct.name || '';
                document.getElementById('highlightProductDescription').value = data.organization.highlightProduct.description || '';
            }
        }
    
        function addContactRow(contactData = {}) {
            const container = document.getElementById('contactsContainer');
            const contactId = `contact_${contactCounter++}`;
            
            const contactRow = document.createElement('div');
            contactRow.className = 'contact-row';
            contactRow.innerHTML = `
                <div>
                    <label>Full Name</label>
                    <input type="text" name="contacts[${contactId}][name]" value="${contactData.name || ''}" placeholder="Sarah Johnson">
                </div>
                <div>
                    <label>Job Title</label>
                    <input type="text" name="contacts[${contactId}][title]" value="${contactData.title || ''}" placeholder="Sales Director">
                </div>
                <div>
                    <label>Circle Username</label>
                    <input type="text" name="contacts[${contactId}][circle]" value="${contactData.circle || ''}" placeholder="@sarahj">
                </div>
                <div>
                    <label>Email</label>
                    <input type="email" name="contacts[${contactId}][email]" value="${contactData.email || ''}" placeholder="sarah@company.com">
                </div>
                <div>
                    <button type="button" class="remove-contact-btn" onclick="removeContactRow(this)">Remove</button>
                </div>
            `;
            
            container.appendChild(contactRow);
        }
    
        function removeContactRow(button) {
            const row = button.closest('.contact-row');
            row.remove();
        }
    
        function handleFileSelect(input, displayElementId) {
            const file = input.files[0];
            const displayElement = document.getElementById(displayElementId);
            
            if (file) {
                displayElement.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                displayElement.style.color = '#28a745';
            } else {
                displayElement.textContent = '';
            }
        }
    
        function handleMultipleFiles(input, displayElementId) {
            const files = Array.from(input.files);
            const displayElement = document.getElementById(displayElementId);
            
            if (files.length > 0) {
                const fileList = files.map(file => 
                    `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`
                ).join('<br>');
                displayElement.innerHTML = `Selected ${files.length} file(s):<br>${fileList}`;
                displayElement.style.color = '#28a745';
            } else {
                displayElement.innerHTML = '';
            }
        }
    
        // Form submission with S3 upload
        document.getElementById('vendorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('🚀 Starting DIRECT S3 form submission...');
            showLoading(true);
            
            try {
                const formData = new FormData(e.target);
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                
                // Collect file info (NO file content yet!)
                const fileList = [];
                const actualFiles = [];
                
                for (let [key, value] of formData.entries()) {
                    if (key.includes('File') && value instanceof File && value.size > 0) {
                        fileList.push({
                            name: value.name,
                            type: value.type,
                            size: value.size,
                            fieldName: key
                        });
                        actualFiles.push({
                            file: value,
                            fieldName: key
                        });
                        console.log(`📎 Found file: ${value.name} (${(value.size / 1024 / 1024).toFixed(2)} MB) from ${key}`);
                    }
                }
        
                let uploadResults = {
                    catalogueUrl: null,
                    otherFiles: []
                };
        
                // If we have files, upload them DIRECTLY to S3
                if (fileList.length > 0) {
                    console.log(`📁 Getting presigned URLs for ${fileList.length} files...`);
                    
                    // Step 1: Get presigned URLs from our backend (NO FILE DATA!)
                    const urlResponse = await fetch(`${API_BASE}/get-presigned-urls`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            fileList: fileList,
                            organizationName: vendorData.organization?.name || 'Unknown Organization',
                            token: token
                        })
                    });
        
                    if (!urlResponse.ok) {
                        const errorData = await urlResponse.json();
                        throw new Error(`Failed to get upload URLs: ${errorData.error}`);
                    }
        
                    const urlData = await urlResponse.json();
                    console.log('🎫 Got presigned URLs!', urlData.uploadUrls.length);
                    
                    // Step 2: Upload each file DIRECTLY to S3 (bypass Vercel!)
                    for (let i = 0; i < urlData.uploadUrls.length; i++) {
                        const urlInfo = urlData.uploadUrls[i];
                        const fileInfo = actualFiles.find(f => f.fieldName === urlInfo.fieldName);
                        
                        if (!fileInfo) {
                            console.error(`❌ No file found for ${urlInfo.fileName}`);
                            continue;
                        }
                        
                        try {
                            console.log(`⬆️ Uploading ${urlInfo.fileName} directly to S3...`);
                            
                            const uploadResponse = await fetch(urlInfo.presignedUrl, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': fileInfo.file.type
                                },
                                body: fileInfo.file // Raw file, not base64!
                            });
                            
                            if (uploadResponse.ok) {
                                if (urlInfo.isCatalogue) {
                                    uploadResults.catalogueUrl = urlInfo.publicUrl;
                                    console.log(`📄 Catalogue uploaded: ${urlInfo.publicUrl}`);
                                } else {
                                    uploadResults.otherFiles.push({
                                        name: urlInfo.fileName,
                                        url: urlInfo.publicUrl,
                                        key: urlInfo.s3Key
                                    });
                                    console.log(`📎 Document uploaded: ${urlInfo.fileName}`);
                                }
                            } else {
                                const errorText = await uploadResponse.text();
                                console.error(`❌ Upload failed for ${urlInfo.fileName}:`, errorText);
                            }
                            
                        } catch (uploadError) {
                            console.error(`💥 Error uploading ${urlInfo.fileName}:`, uploadError);
                        }
                    }
                    
                    console.log('🎉 All S3 uploads complete!', uploadResults);
                }
        
                // Step 3: Submit form data (with file URLs) to our backend
                const jsonData = {
                    token: token,
                    uploadResults: uploadResults
                };
                
                // Add all text form fields
                for (let [key, value] of formData.entries()) {
                    if (!key.includes('File') && value && typeof value === 'string') {
                        jsonData[key] = value;
                    }
                }
                
                console.log('📤 Submitting form data to backend...');
                
                const response = await fetch(`${API_BASE}/update-vendor-profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Backend error: ${errorData.error}`);
                }
                
                const result = await response.json();
                console.log('✨ Backend response:', result);
                
                showLoading(false);
                document.getElementById('profileForm').style.display = 'none';
                document.getElementById('successState').style.display = 'block';
                
            } catch (error) {
                console.error('💥 Form submission failed:', error);
                showLoading(false);
                showError('Failed to update profile. Please try again.');
            }
        });
    
          function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
        }
    </script>
</body>
</html>
